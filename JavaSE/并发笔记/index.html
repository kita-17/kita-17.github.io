<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="kita17">
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    
    <!--- Seo Part-->
    
    <link rel="canonical" href="http://kita-17.github.io/javase/并发笔记/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
        <meta name="description" content="进程：是指⼀个内存中运⾏的应⽤程序，每个进程都有⼀个独⽴的内存空间，⼀个应⽤程序可以同时运⾏多个进程；进程也是程序的⼀次执⾏过程，是系统运⾏程序的基本单位；系统运⾏⼀个程序即是 ⼀个进程从创建、运⾏到消亡的过程。线程：线程是进程中的⼀个执⾏单元，负责当前进程中程序的执⾏，⼀个进程中⾄少有⼀个线程。⼀个进程中是可以有多个线程的，这个应⽤程序也可以称之为多线程程序。并发：指两个或多个事件在同⼀个时间">
<meta property="og:type" content="article">
<meta property="og:title" content="并发笔记">
<meta property="og:url" content="http://kita-17.github.io/JavaSE/%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="进程：是指⼀个内存中运⾏的应⽤程序，每个进程都有⼀个独⽴的内存空间，⼀个应⽤程序可以同时运⾏多个进程；进程也是程序的⼀次执⾏过程，是系统运⾏程序的基本单位；系统运⾏⼀个程序即是 ⼀个进程从创建、运⾏到消亡的过程。线程：线程是进程中的⼀个执⾏单元，负责当前进程中程序的执⾏，⼀个进程中⾄少有⼀个线程。⼀个进程中是可以有多个线程的，这个应⽤程序也可以称之为多线程程序。并发：指两个或多个事件在同⼀个时间">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://s2.loli.net/2023/04/08/IPmn4zVktUj17JS.png">
<meta property="og:image" content="https://s2.loli.net/2023/04/08/PShe3OKIo4ZGEuc.png">
<meta property="og:image" content="https://s2.loli.net/2023/04/13/n4dCaipItyRQ5sY.png">
<meta property="og:image" content="https://s2.loli.net/2023/04/08/cYJVz89S3PQuOTM.png">
<meta property="og:image" content="https://s2.loli.net/2023/04/14/TfPtvSrs1WleBVI.png">
<meta property="article:published_time" content="2022-10-06T16:00:00.000Z">
<meta property="article:modified_time" content="2023-04-14T04:45:33.438Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="java">
<meta property="article:tag" content="note">
<meta property="article:tag" content="thread">
<meta property="article:tag" content="concurrent">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2023/04/08/IPmn4zVktUj17JS.png">
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/images/logo.png" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.png">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="/images/logo.png">
    <!--- Page Info-->
    
    <title>
        
            并发笔记 -
        
        KITA!!
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
<link rel="stylesheet" href="/assets/fonts.css">

    <!--- Font Part-->
    
    
        <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@500&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    
    
    

    <!--- Inject Part-->
    
    <script id="hexo-configurations">
    let Global = window.Global || {};
    Global.hexo_config = {"hostname":"kita-17.github.io","root":"/","language":"en","path":"search.xml"};
    Global.theme_config = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":true,"auto":false,"list":[""]},"code_block":{"copy":true,"style":"simple","font":{"enable":true,"family":"Fira Code","url":"https://fonts.googleapis.com/css2?family=Fira+Code:wght@500&family=JetBrains+Mono:wght@500&display=swap"}},"toc":{"enable":true,"max_depth":3,"number":false,"expand":true,"init_open":true},"copyright":false,"lazyload":true,"recommendation":{"enable":false,"title":"推荐阅读","limit":3,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":null},"global":{"fonts":{"chinese":{"enable":false,"family":null,"url":null},"english":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":true},"scroll_progress":{"bar":false,"percentage":true},"busuanzi_counter":{"enable":true,"site_pv":true,"site_uv":true,"post_pv":true},"pjax":true,"open_graph":true,"google_analytics":{"enable":false,"id":null}},"home_banner":{"enable":true,"style":"static","image":{"light":"/images/banner-light.png","dark":"/images/banner-dark.png"},"title":"KITA KITA!!","subtitle":{"text":[],"hitokoto":{"enable":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#fff","dark":"#d1d1b6"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":false,"links":{"github":"https://github.com/kita-17","instagram":null,"zhihu":null,"twitter":null,"email":null}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null}]},"mermaid":{"enable":false,"version":"9.3.0"}},"version":"2.1.5","navbar":{"auto_hide":false,"color":{"left":"#f78736","right":"#367df7","transparency":35},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"Archives":{"path":"/archives","icon":"fa-regular fa-archive"},"Tags":{"icon":"fa-regular fa-tag","path":"/tags"},"Categories":{"icon":"fa-regular fa-book","path":"/categories"}},"search":{"enable":true,"preload":true}},"page_templates":{"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":null,"links":{"Archives":{"path":"/archives","icon":"fa-regular fa-archive"},"Tags":{"path":"/tags","icon":"fa-regular fa-tags"},"Categories":{"path":"/categories","icon":"fa-regular fa-folder"}}},"article_date_format":"auto","categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}}};
    Global.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
    Global.data_config = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
<div class="progress-bar-container">
    

    
        <span class="pjax-progress-bar"></span>
        <span class="pjax-progress-icon">
            <i class="fa-solid fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container">

    

    <div class="main-content-container">

        <div class="main-content-header">
            <header class="navbar-container">
    
    <div class="navbar-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                KITA!!
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/"  >
                                    
                                        
                                            <i class="fa-regular fa-house"></i>
                                        
                                        HOME
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/archives"  >
                                    
                                        
                                            <i class="fa-regular fa-archive"></i>
                                        
                                        ARCHIVES
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/tags"  >
                                    
                                        
                                            <i class="fa-regular fa-tag"></i>
                                        
                                        TAGS
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/categories"  >
                                    
                                        
                                            <i class="fa-regular fa-book"></i>
                                        
                                        CATEGORIES
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                    
                        <li class="navbar-item search search-popup-trigger">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </li>
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i></div>
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile drawer -->
    <div class="navbar-drawer">
        <ul class="drawer-navbar-list">
            
                
                    <li class="drawer-navbar-item flex-center">
                        <a class="" 
                        href="/"  >
                             
                                
                                    <i class="fa-regular fa-house"></i>
                                
                                HOME
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item flex-center">
                        <a class="" 
                        href="/archives"  >
                             
                                
                                    <i class="fa-regular fa-archive"></i>
                                
                                ARCHIVES
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item flex-center">
                        <a class="" 
                        href="/tags"  >
                             
                                
                                    <i class="fa-regular fa-tag"></i>
                                
                                TAGS
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item flex-center">
                        <a class="" 
                        href="/categories"  >
                             
                                
                                    <i class="fa-regular fa-book"></i>
                                
                                CATEGORIES
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            

        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="main-content-body">

            

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="post-page-container">
        <div class="article-content-container">

            
            
                <div class="article-title">
                    <h1 class="article-title-regular">并发笔记</h1>
                </div>
            
                
            

            
                <div class="article-header">
                    <div class="avatar">
                        <img src="/images/avatar.png">
                    </div>
                    <div class="info">
                        <div class="author">
                            <span class="name">kita17</span>
                            
                                <span class="author-label"></span>
                            
                        </div>
                        <div class="meta-info">
                            <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2022-10-07</span>
        <span class="mobile">2022-10-07 00</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2023-04-14 12:45:33</span>
            <span class="mobile">2023-04-14 12:45</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
        <span class="article-categories article-meta-item">
            <i class="fa-regular fa-folders"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/note/">note</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/java/">java</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/note/">note</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/thread/">thread</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/concurrent/">concurrent</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                        </div>
                    </div>
                </div>
            

            <div class="article-content markdown-body">
                <blockquote>
<p><strong>进程</strong>：是指⼀个内存中运⾏的应⽤程序，每个进程都有⼀个独⽴的内存空间，⼀个应⽤程序可以同时运⾏多个进程；进程也是程序的⼀次执⾏过程，是系统运⾏程序的基本单位；系统运⾏⼀个程序即是 ⼀个进程从创建、运⾏到消亡的过程。<br><strong>线程</strong>：线程是进程中的⼀个执⾏单元，负责当前进程中程序的执⾏，⼀个进程中⾄少有⼀个线程。⼀个进程中是可以有多个线程的，这个应⽤程序也可以称之为多线程程序。<br><strong>并发</strong>：指两个或多个事件在<strong>同⼀个时间段内</strong>发⽣（一个时间段内，轮流做一些事）<br><strong>并⾏</strong>：指两个或多个事件在<strong>同⼀时刻</strong>发⽣（一个时间段内，同时做某些事）<br><strong>同步</strong>：需要等待结果返回才能继续运行叫同步（单线程方法一行一行顺序执行）。在多线程中还有另外一个意思。让多线程步调一致<br><strong>异步</strong>：不需要等待结果返回就能继续运行叫异步（多线程并行执行）</p>
</blockquote>
<ul>
<li>JVM中的栈内存是给线程使用的，每个线程启动后，JVM会为其分配一块栈内存</li>
<li>Java默认有两个线程，main和gc</li>
</ul>
<h3 id="使用线程的几种方法"><a href="#使用线程的几种方法" class="headerlink" title="使用线程的几种方法"></a>使用线程的几种方法</h3><ol>
<li><p>继承 <code>Thread</code> 类, 重写 <code>run</code> 方法</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;23333&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//使用</span></span><br><span class="line"><span class="type">MyThread</span> <span class="variable">myThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyThread</span>();  </span><br><span class="line">myThread.start();</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>实现 <code>Runnable</code> 接口, 重写 <code>run</code> 方法</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">YouThread</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;114514&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//使用</span></span><br><span class="line"><span class="type">Thread</span> <span class="variable">youThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">YouThread</span>()); </span><br><span class="line">youThread.start();</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>匿名子类的方式</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>()&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span>&#123;</span><br><span class="line">		<span class="comment">//业务代码</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;.start();</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>Runnable匿名子类的方式</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>()&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span>&#123;</span><br><span class="line">		<span class="comment">//业务代码</span></span><br><span class="line">	&#125;	</span><br><span class="line">&#125;).start();</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>使用线程池</p>
<blockquote>
<p>关于线程池更具体的笔记，查看 <a href="/JavaSE/%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0/../%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0/#%E7%BA%BF%E7%A8%8B%E6%B1%A0">线程池</a></p>
</blockquote>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ExecutorService</span> <span class="variable">pool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">3</span>);</span><br><span class="line">pool.execute(<span class="keyword">new</span> <span class="title class_">Runable</span>()&#123;<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span>&#123;&#125;&#125;);</span><br><span class="line"></span><br><span class="line">Executors.newCachedThreadPool().execute(<span class="keyword">new</span> <span class="title class_">Runable</span>()&#123;<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span>&#123;&#125;&#125;);</span><br><span class="line"></span><br><span class="line">Executors.newSingleThreadExecutor().execute(<span class="keyword">new</span> <span class="title class_">Runable</span>()&#123;<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span>&#123;&#125;&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 推荐下方这种</span></span><br><span class="line">ArrayBlockingQueue&lt;Runnable&gt; queue = <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">2</span>); <span class="comment">// 队列长度2</span></span><br><span class="line"><span class="type">ThreadPoolExecutor</span> <span class="variable">poolExecutor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">2</span>, <span class="number">5</span>, <span class="number">0</span>, TimeUnit.SECONDS,  </span><br><span class="line">queue, r -&gt; <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="string">&quot;t1&quot;</span>), <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.AbortPolicy());</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>Callable接口实现，具体请查看下方 <a href="/JavaSE/%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0/../%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0/#Callable%E6%8E%A5%E5%8F%A3">Callable</a></p>
</li>
</ol>
<h3 id="线程的状态"><a href="#线程的状态" class="headerlink" title="线程的状态"></a>线程的状态</h3><h5 id="Java代码层面下的线程状态分为下图中的几种"><a href="#Java代码层面下的线程状态分为下图中的几种" class="headerlink" title="Java代码层面下的线程状态分为下图中的几种"></a>Java代码层面下的线程状态分为下图中的几种</h5><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2023/04/08/IPmn4zVktUj17JS.png"
                      alt="image.png"
                ></p>
<h3 id="状态切换"><a href="#状态切换" class="headerlink" title="状态切换"></a>状态切换</h3><ul>
<li>NEW 新建：刚创建出来，还未跟操作系统的线程关联，仅仅只是个Java对象</li>
<li>RUNNABLE 可运行：调用 <code>start</code> 方法后，会与系统真正的线程关联。并执行 <code>run</code> 方法的代码</li>
<li>TERMINATED 终结：当 <code>run</code> 方法执行完毕后，线程进入 <code>TERMINATED</code> 。表示线程生命周期结束。开始释放系统线程相关资源</li>
<li>BLOCKED 阻塞：获取锁失败后阻塞等待锁释放。锁释放后会再参与锁竞争。如果竞争成功就会转为 <code>RUNNABLE</code> 如果再次失败就再次阻塞</li>
<li>WATING 等待：线程获取锁成功后，有时会发现继续执行的条件不满足，这时可以选择让出锁进入等待状态。当条件满足后由其他线程唤醒。唤醒后需重新竞争锁</li>
<li>TIMED_WAITING 等待（有时限）：与WATING状态一样，区别是有等待时间，时间到自动唤醒或被唤醒。线程休眠(sleep)也会从 <code>RUNNABLE</code> 转到 <code>TIMED_WAITING</code></li>
</ul>
<h5 id="操作系统下的线程状态"><a href="#操作系统下的线程状态" class="headerlink" title="操作系统下的线程状态"></a>操作系统下的线程状态</h5><blockquote>
<p>操作系统层面下分为5种：新建 就绪 阻塞 运行 终结</p>
</blockquote>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2023/04/08/PShe3OKIo4ZGEuc.png"
                      alt="image.png"
                ></p>
<ul>
<li>分到cpu时间：运行</li>
<li>可以分到cpu时间：就绪</li>
<li>分不到cpu时间：阻塞</li>
<li>Java种的 RUNNABLE 涵盖；额就绪，运行，阻塞IO</li>
</ul>
<h3 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h3><h4 id="wait-与-sleep"><a href="#wait-与-sleep" class="headerlink" title="wait 与 sleep"></a>wait 与 sleep</h4><ol>
<li>共同点：wait(), wait(long),sleep(lone) 效果都是让出cpu，进入阻塞状态</li>
<li>方法归属不同<ol>
<li>sleep属于Thread的静态方法</li>
<li>wait&#x2F;wait(long) 属于Object的成员方法，每个对象都有</li>
</ol>
</li>
<li>醒来时机不同<ol>
<li>执行sleep(long)和wait(long)的线程会在指定时间后自动醒来</li>
<li>wait() 和 wait(long) 还可以被 notify唤醒</li>
<li>都可以用打断 <code>interrupt</code> 的方式来唤醒</li>
</ol>
</li>
<li>锁特性不同<ol>
<li>wait需要调用的线程先获取到锁，sleep则不用获取锁</li>
<li>wait执行后会释放锁，sleep不会释放锁</li>
</ol>
</li>
</ol>
<h3 id="Lock与synchronized"><a href="#Lock与synchronized" class="headerlink" title="Lock与synchronized"></a>Lock与synchronized</h3><blockquote>
<p>这两个都是悲观锁。都具备互斥，同步，重入功能</p>
</blockquote>
<h4 id="synchronized"><a href="#synchronized" class="headerlink" title="synchronized"></a>synchronized</h4><ul>
<li>synchronized是一个关键字，由c++实现，不可中断，非公平，获取锁失败会等待</li>
<li>使用synchronized时，退出同步代码块后，锁就会释放。而Lock需要手动释放</li>
<li>在竞争不激烈时， synchronized做了许多优化，如偏向锁，轻量级锁，性能不错</li>
</ul>
<h5 id="作用范围"><a href="#作用范围" class="headerlink" title="作用范围"></a>作用范围</h5><ol>
<li>作用于成员变量和非静态方法，锁住的是对象的实例，即this对象 如：<code>String a = new String(&quot;123&quot;)</code> 这里锁的是 <code>a</code> <mark style="background: #FFB86CA6;">指向的对象</mark></li>
<li>作用在静态方法，锁住的是Class模板</li>
<li>作用在代码块，同一时刻只能有一个线程执行该方法体或者代码块</li>
</ol>
<h4 id="Lock"><a href="#Lock" class="headerlink" title="Lock"></a>Lock</h4><ul>
<li>Lock是一个接口，由JDK实现，可以判断是否获取到锁，获取锁失败不会等待</li>
<li>Lock提供了 synchronized 没有的功能。例如获取等待状态、公平锁、可超时、多条件变量</li>
<li>Lock有适合不同场景的实现，如 ReentrantLock， ReentrantReadWriteLock</li>
<li>Lock可以搭配 <code>Condition</code> 精确唤醒和等待</li>
<li>在竞争激烈时，Lock的性能会更好些</li>
</ul>
<h5 id="作用范围-1"><a href="#作用范围-1" class="headerlink" title="作用范围"></a>作用范围</h5><p>锁住的是 <code>lock()</code> 与 <code>unlock()</code> 中间的代码</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">lock.lock(); <span class="comment">// 开始</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//锁住这里的代码</span></span><br><span class="line">&#125; <span class="keyword">finally</span> &#123; <span class="comment">// finally解锁，防止死锁</span></span><br><span class="line">    lock.unlock(); <span class="comment">//结束</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>Lock锁必须配对，调用了几次 lock方法加锁，就必须调用几次 unlock 解锁</p>
</blockquote>
<h3 id="生产者和消费者问题"><a href="#生产者和消费者问题" class="headerlink" title="生产者和消费者问题"></a>生产者和消费者问题</h3><h4 id="synchronized-wait-x2F-notifyAll方法"><a href="#synchronized-wait-x2F-notifyAll方法" class="headerlink" title="synchronized | wait&#x2F;notifyAll方法"></a>synchronized | wait&#x2F;notifyAll方法</h4><p>一个简的生产者消费者问题。使用synchronized来加锁，线程A+1 线程B -1</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Data</span> <span class="variable">data</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Data</span>();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">15</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    data.increment();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;A&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">15</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    data.decrement();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;B&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Data</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">value</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">increment</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">	    <span class="comment">//这里一般会是阻塞队列来判断</span></span><br><span class="line">        <span class="keyword">while</span> (value != <span class="number">0</span>) &#123; <span class="comment">//使用while防止虚假唤醒</span></span><br><span class="line">            <span class="built_in">this</span>.wait();</span><br><span class="line">        &#125;</span><br><span class="line">        value++;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot;: &quot;</span> + value);</span><br><span class="line">        <span class="built_in">this</span>.notifyAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">decrement</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">while</span> (value == <span class="number">0</span>) &#123; <span class="comment">//使用while防止虚假唤醒</span></span><br><span class="line">            <span class="built_in">this</span>.wait();</span><br><span class="line">        &#125;</span><br><span class="line">        value--;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot;: &quot;</span> + value);</span><br><span class="line">        <span class="built_in">this</span>.notifyAll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="JUC-await-x2F-signal-方法"><a href="#JUC-await-x2F-signal-方法" class="headerlink" title="JUC | await()&#x2F;signal()方法"></a>JUC | await()&#x2F;signal()方法</h4><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Data</span> <span class="variable">data</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Data</span>();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">15</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    data.increment();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;A&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">15</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    data.decrement();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;B&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Data</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">value</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">Lock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>(); <span class="comment">//创建锁</span></span><br><span class="line">    <span class="type">Condition</span> <span class="variable">condition</span> <span class="operator">=</span> lock.newCondition();<span class="comment">//创建监视器</span></span><br><span class="line">    <span class="comment">//当然一把锁可以创建多个监视器，通过监视器，我们可以精确控制唤醒与等待</span></span><br><span class="line">    <span class="comment">//Condition condition1 = lock.newCondition();</span></span><br><span class="line">    <span class="comment">//Condition condition2 = lock.newCondition();</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">increment</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (value != <span class="number">0</span>) &#123;</span><br><span class="line">                condition.await();</span><br><span class="line">            &#125;</span><br><span class="line">            value++;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot;: &quot;</span> + value);</span><br><span class="line">            condition.signalAll();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">decrement</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (value == <span class="number">0</span>) &#123;</span><br><span class="line">                condition.await();</span><br><span class="line">            &#125;</span><br><span class="line">            value--;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot;: &quot;</span> + value);</span><br><span class="line">            condition.signalAll();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="集合类不安全问题"><a href="#集合类不安全问题" class="headerlink" title="集合类不安全问题"></a>集合类不安全问题</h3><blockquote>
<p>线程不安全的集合有 ArrayList，HashSet，HashMap 线程安全的集合有 CopyOnWriteArrayList，CopyOnWriteArraySet，ConcurrentHashMap 作用是一样的，只是前者线程不安全，后者安全</p>
<p>早期Java提供了Vector线程安全的集合，但效率较低。且扩容是原来的一倍。需要连续的内存空间等问题现在Java已经不推荐使用了。</p>
</blockquote>
<h4 id="ConCurrentModificationException-异常"><a href="#ConCurrentModificationException-异常" class="headerlink" title="ConCurrentModificationException 异常"></a>ConCurrentModificationException 异常</h4><p>当多个线程往一个集合中添加内容时会报 <code>ConCurrentModificationException</code> 异常</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">addList</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">30</span> ; i++) &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">            list.add(UUID.randomUUID().toString().substring(<span class="number">0</span>,<span class="number">6</span>));</span><br><span class="line">            System.out.println(list);</span><br><span class="line">        &#125;,String.valueOf(i)).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h4><ol>
<li>使用 <code>Collections.synchronizedList(new ArrayList&lt;&gt;())</code> 创建一个线程安全的List</li>
<li>使用 <code>CopyOnWriteArrayList</code> 代替 <code>ArrayList</code></li>
<li>使用 <code>CopyOnWriteArraySet</code> 代替 <code>HashSet</code></li>
<li>使用 <code>ConcurrentHashMap</code> 代替 <code>HashMap</code></li>
</ol>
<p>上述的线程安全集合容器底层的add或put方法使用了 <code>ReentrantLock</code> 来保证线程安全</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(E e)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="built_in">this</span>.lock;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">	     <span class="comment">//获取当前对象数组</span></span><br><span class="line">        Object[] elements = getArray();</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> elements.length;</span><br><span class="line">        <span class="comment">//创建一个新数组，并把旧数组的内容复制到新数组</span></span><br><span class="line">        Object[] newElements = Arrays.copyOf(elements, len + <span class="number">1</span>);</span><br><span class="line">        <span class="comment">//往新数组里插入新值</span></span><br><span class="line">        newElements[len] = e;</span><br><span class="line">        <span class="comment">//将原容器指向新容器</span></span><br><span class="line">        setArray(newElements);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<ul>
<li>这些集合容器都是有线程锁的，所以是线程安全的</li>
<li>CopyOnWrite容器即写时复制的容器。往一个容器添加元素的时候，不直接往当前容器Object[ ]添加，而是先将当前容器Object[ ]进行Copy，复制出一个新的容器Object[] newElements，然后往新的容器Object[ ] newElements里添加元素，添加完元素之后，再将原容器的引用指向新的容器 setArray(newElements)。</li>
<li>好处是可以对CopyOnWrite容器进行并发的读，而不需要加锁，因为当前容器不会添加任何元素。所以CopyOnWrite容器也是一种读写分离的思想，读和写不同的容器</li>
</ul>
<h3 id="Callable接口"><a href="#Callable接口" class="headerlink" title="Callable接口"></a>Callable接口</h3><blockquote>
<p>Callable 接口类似于 Runnable，都是为了其实例可能由另一个线程执行而设计的。但是Runnable不返回结果，也不抛出被检查到的异常</p>
</blockquote>
<ul>
<li>Callable可以有返回值</li>
<li>Callable可以抛异常</li>
<li>方法不同 run() &#x2F; call()</li>
</ul>
<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><p>Callable无法像Runnable那样可以直接被Thread使用。需要添加一个适配类 <code>FutureTask</code></p>
<blockquote>
<p><mark style="background: #FFB86CA6;">需要注意的是一个 FutureTask 只能绑定一个线程</mark></p>
</blockquote>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test4</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">        <span class="comment">//创建适配类 FutureTask, 当然也支持lambda表达式</span></span><br><span class="line">        <span class="comment">// FutureTask task = new FutureTask&lt;&gt;(()-&gt;&#123;</span></span><br><span class="line">        <span class="comment">//    业务代码...</span></span><br><span class="line">        <span class="comment">//    return &quot;线程返回值&quot;;</span></span><br><span class="line">        <span class="comment">//&#125;);</span></span><br><span class="line">        <span class="type">FutureTask</span> <span class="variable">task</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FutureTask</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">MyCallable</span>());</span><br><span class="line">		<span class="keyword">new</span> <span class="title class_">Thread</span>(task).start(); <span class="comment">//结果会被缓存</span></span><br><span class="line">        <span class="comment">//获取返回值</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> task.get(); <span class="comment">//可能产生阻塞，可能需要等待结果返回</span></span><br><span class="line">        System.out.println(o); <span class="comment">//输出 -&gt; 线程返回值</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyCallable</span> <span class="keyword">implements</span> <span class="title class_">Callable</span>&lt;String&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;线程返回值&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="常用辅助类"><a href="#常用辅助类" class="headerlink" title="常用辅助类"></a>常用辅助类</h3><h4 id="CountDownLatch"><a href="#CountDownLatch" class="headerlink" title="CountDownLatch"></a>CountDownLatch</h4><blockquote>
<p>CountDownLatch是JUC包下的一个<mark style="background: #FFF3A3A6;">线程同步工具类</mark> 允许一个或多个线程等待，直到其他线程操作完成，等待线程才会继续往下执行。也可以叫做减法计数器</p>
</blockquote>
<p> <code>CountDownLatch</code> 是调用 <code>await()</code> 方法的线程等待 调用 <code>countDown()</code> 方法的线程，就像主管等待所有员工干完活一样</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">CountDownLatch</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">     <span class="comment">//倒计时 -1</span></span><br><span class="line">        countDownLatch.countDown();</span><br><span class="line">        System.out.println(<span class="string">&quot;线程一执行完毕&quot;</span>);</span><br><span class="line">    &#125;).start();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">     <span class="comment">//倒计时 -1</span></span><br><span class="line">        countDownLatch.countDown();</span><br><span class="line">        System.out.println(<span class="string">&quot;线程二执行完毕&quot;</span>);</span><br><span class="line">    &#125;).start();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="comment">//倒计时 -1</span></span><br><span class="line">        countDownLatch.countDown();</span><br><span class="line">        System.out.println(<span class="string">&quot;线程三执行完毕&quot;</span>);</span><br><span class="line">    &#125;).start();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">5</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//倒计时 -1</span></span><br><span class="line">            countDownLatch.countDown();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;线程四执行完毕&quot;</span>);</span><br><span class="line">    &#125;).start();</span><br><span class="line">    <span class="comment">//倒计时器等待计数器归0, 然后在向下执行</span></span><br><span class="line">    countDownLatch.await();</span><br><span class="line">    System.out.println(<span class="string">&quot;所有线程执行完毕, 这句才会输出&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>countDownLatch.countDown()：计数器 - 1</li>
<li>countDownLatch.await()：等待计数器归0后，在向下执行</li>
</ul>
<p>CountDownLatch是基于AQS（AbstractQueuedSynchronizer）实现的。当我们在构建CountDownLatch对象时，传入的值就会赋值给 AQS 的关键变量state，执行countDown方法时，利用CAS 将state 减一，执行await方法时，判断state是否为0，不为0则加入到队列中，将该线程阻塞掉（除头节点外）。头节点会一直自旋等待state为0，当state为0时，头节点会把队列中剩余的阻塞节点一起唤醒</p>
<h4 id="CyclicBarrier"><a href="#CyclicBarrier" class="headerlink" title="CyclicBarrier"></a>CyclicBarrier</h4><blockquote>
<p>CyclicBarrier是JUC包下的一个<mark style="background: #FFF3A3A6;">线程同步工具类</mark> 。当线程到达某状态后，暂停下来等待其他线程，等到所有线程均到达以后，才继续执行。也可以叫做加法计数器</p>
</blockquote>
<p>CyclicBarrier是调用 <code>await()</code> 方法的任务线程 等待其他 调用<code>await()</code> 方法的任务线程，就像每个员工干完自己手里的活后等待其他员工干完。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">CyclicBarrier</span> <span class="variable">cyclicBarrier</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CyclicBarrier</span>(<span class="number">4</span>, () -&gt; &#123; <span class="comment">// 这是一个Runnable</span></span><br><span class="line">    System.out.println(<span class="string">&quot;计数器到4后执行这里的代码&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">temp</span> <span class="operator">=</span> i;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;执行: &quot;</span> + temp);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">	        <span class="comment">//一些业务代码</span></span><br><span class="line">            cyclicBarrier.await(); 。<span class="comment">// 当线程执行完某些业务代码后停下来等待其他线程也执行到这</span></span><br><span class="line">            <span class="comment">//其他的业务代码</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException | BrokenBarrierException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="Semaphore"><a href="#Semaphore" class="headerlink" title="Semaphore"></a>Semaphore</h4><blockquote>
<p>信号量，<mark style="background: #ADCCFFA6;">用来限制能同时访问共享资源的线程上限</mark> </p>
</blockquote>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//初始化信号量</span></span><br><span class="line"><span class="comment">//public Semaphore(int permits)：permits 表示许可线程的数量</span></span><br><span class="line"><span class="comment">//public Semaphore(int permits, boolean fair)：fair 表示公平性，如果设为 true，表示是公平，那么等待最久的线程先执行</span></span><br><span class="line"><span class="type">Semaphore</span> <span class="variable">semaphore</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Semaphore</span>(<span class="number">4</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">6</span>; i++) &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">finalI</span> <span class="operator">=</span> i</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">	        <span class="comment">//获取一个许可证，如果获取不到则阻塞等待</span></span><br><span class="line">            semaphore.acquire();</span><br><span class="line">            System.out.println(finalI + <span class="string">&quot; &gt; 开始执行业务代码&quot;</span>);</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">5</span>);</span><br><span class="line">            System.out.println(finalI + <span class="string">&quot; &gt; 业务代码执行完毕&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">	        <span class="comment">//释放许可证</span></span><br><span class="line">            semaphore.release();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>acquire()：获取一个许可证，对应线程许可证会 -1。获取不到会阻塞等待</li>
<li>release()：释放一个许可证，对应线程许可证会 +1。唤醒等待线程</li>
</ul>
<h3 id="ReadWriteLock-读写锁"><a href="#ReadWriteLock-读写锁" class="headerlink" title="ReadWriteLock 读写锁"></a>ReadWriteLock 读写锁</h3><blockquote>
<p>读写锁是一把锁分为两部分：读锁和写锁。因为<mark style="background: #ADCCFFA6;">读操作是共享的所以线程安全</mark>，而<mark style="background: #ADCCFFA6;">写操作是互斥的所以线程不安全</mark>。在同一时刻，读写锁允许多个线程同时获得读锁，但只允许一个线程获取写锁，且一旦有一个线程获取到写锁，那其它线程就无法获取读和写锁。写的时候也可以读，但度的时候不能写。可以概括为 <mark style="background: #FFF3A3A6;">读读并发</mark>、<mark style="background: #BBFABBA6;">读写互斥</mark>、<mark style="background: #FFF3A3A6;">写写互斥</mark> <mark style="background: #BBFABBA6;">适合读多写少的业务场景</mark></p>
</blockquote>
<ul>
<li>为什么需要读写锁？<ul>
<li>Synchronized 和 ReentrantLock 都是独占锁，即在同一时刻只有一个线程获取到锁。但在大多数情况下，读操作往往大于写操作。在这种情况下如果使用独占锁，效率将会低下。</li>
</ul>
</li>
<li>读写锁的特点<ul>
<li>公平性：读写锁支持非公平和公平的锁获取方式，非公平锁的吞吐量优于公平锁的吞吐量，默认构造的是非公平锁</li>
<li>可重入：在线程获取读锁之后能够再次获取读锁，但是不能获取写锁，而线程在获取写锁之后能够再次获取写锁，同时也能获取读锁</li>
<li>锁降级：线程获取写锁之后获取读锁，再释放写锁，这样实现了写锁变为读锁，也叫锁降级</li>
</ul>
</li>
</ul>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test6</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">MyDataLock</span> <span class="variable">myDataLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyDataLock</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">finalI</span> <span class="operator">=</span> i;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                myDataLock.set(String.valueOf(finalI), <span class="string">&quot;1&quot;</span>);</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">finalI</span> <span class="operator">=</span> i;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                myDataLock.get(String.valueOf(finalI));</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyDataLock</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ReadWriteLock</span> <span class="variable">readWriteLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantReadWriteLock</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(String key, String value)</span> &#123;</span><br><span class="line">        readWriteLock.writeLock().lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(key + <span class="string">&quot; &gt; 正在写入&quot;</span>);</span><br><span class="line">            map.put(key, value);</span><br><span class="line">            System.out.println(key + <span class="string">&quot; &gt; 写入完成&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            readWriteLock.writeLock().unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">get</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        readWriteLock.readLock().lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(key + <span class="string">&quot; &gt; 正在读取&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> map.get(key);</span><br><span class="line">            System.out.println(key + <span class="string">&quot; &gt; 读取完成&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            readWriteLock.readLock().unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//结果</span></span><br><span class="line"><span class="number">0</span> &gt; 正在写入</span><br><span class="line"><span class="number">0</span> &gt; 写入完成 <span class="comment">// 每一次写入完成后才会换下个线程</span></span><br><span class="line"><span class="number">1</span> &gt; 正在写入</span><br><span class="line"><span class="number">1</span> &gt; 写入完成</span><br><span class="line"><span class="number">4</span> &gt; 正在写入</span><br><span class="line"><span class="number">4</span> &gt; 写入完成</span><br><span class="line"><span class="number">2</span> &gt; 正在写入</span><br><span class="line"><span class="number">2</span> &gt; 写入完成</span><br><span class="line"><span class="number">3</span> &gt; 正在写入</span><br><span class="line"><span class="number">3</span> &gt; 写入完成</span><br><span class="line"><span class="number">1</span> &gt; 正在读取</span><br><span class="line"><span class="number">1</span> &gt; 读取完成</span><br><span class="line"><span class="number">2</span> &gt; 正在读取</span><br><span class="line"><span class="number">2</span> &gt; 读取完成</span><br><span class="line"><span class="number">3</span> &gt; 正在读取 <span class="comment">// 线程3读取</span></span><br><span class="line"><span class="number">0</span> &gt; 正在读取 <span class="comment">// 被线程0插队</span></span><br><span class="line"><span class="number">0</span> &gt; 读取完成 <span class="comment">// 后来的线程0读取完成早于先来的线程3</span></span><br><span class="line"><span class="number">3</span> &gt; 读取完成</span><br><span class="line"><span class="number">4</span> &gt; 正在读取</span><br><span class="line"><span class="number">4</span> &gt; 读取完成</span><br></pre></td></tr></table></figure></div>

<p>通过简单的例子可以看到。每一次的写入操作完成后才会轮到下一个线程写入，而读取时，会被其他线程插队，先读取到</p>
<h3 id="BlockingQueue-阻塞队列"><a href="#BlockingQueue-阻塞队列" class="headerlink" title="BlockingQueue 阻塞队列"></a>BlockingQueue 阻塞队列</h3><blockquote>
<p>一个支持两个附加操作的队列，这两个附加操作是<br>当写入时队列满了，写入操作会等待队列空出位置再继续写入<br>当读取时队列空了，读取操作会等待队列写入数据后再继续读取<br>一般应用在生产者与消费者场景</p>
</blockquote>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2023/04/13/n4dCaipItyRQ5sY.png"
                      alt="image.png"
                ></p>
<h4 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h4><h5 id="add"><a href="#add" class="headerlink" title="add"></a>add</h5><p>往队列里添加元素，如果失败会抛出异常</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">BlockingQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>(<span class="number">3</span>);</span><br><span class="line">    queue.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    queue.add(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">    queue.add(<span class="string">&quot;3&quot;</span>);</span><br><span class="line">    <span class="comment">// java.lang.IllegalStateException: Queue full</span></span><br><span class="line">    queue.add(<span class="string">&quot;4&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h5 id="remove"><a href="#remove" class="headerlink" title="remove"></a>remove</h5><p>检索并删除此队列的头部</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//队列没有元素</span></span><br><span class="line"><span class="type">BlockingQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>(<span class="number">3</span>);</span><br><span class="line"><span class="comment">//java.util.NoSuchElementException</span></span><br><span class="line">queue.remove(); <span class="comment">//移除失败，会抛出异常</span></span><br></pre></td></tr></table></figure></div>

<h5 id="offer"><a href="#offer" class="headerlink" title="offer"></a>offer</h5><p>在不违反容量限制的情况下立即将指定的元素插入到此队列中，成功返回true，失败返回false</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">BlockingQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>(<span class="number">3</span>);</span><br><span class="line"><span class="type">boolean</span> <span class="variable">offer</span> <span class="operator">=</span> queue.offer(<span class="string">&quot;1&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//当队列没有空间可插入元素时，将阻塞等待队列可用</span></span><br><span class="line"><span class="comment">//一秒后队列还不可用的话就结束等待</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">offer</span> <span class="operator">=</span> queue.offer(<span class="string">&quot;1&quot;</span>, <span class="number">1</span>, TimeUnit.SECONDS);</span><br></pre></td></tr></table></figure></div>

<h5 id="poll"><a href="#poll" class="headerlink" title="poll"></a>poll</h5><p>获取并删除此队列的头部，如果队列是空的，则返回null</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">BlockingQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>(<span class="number">3</span>);</span><br><span class="line"><span class="comment">//获取并删除此队列的头部</span></span><br><span class="line"><span class="type">Object</span> <span class="variable">poll</span> <span class="operator">=</span> queue.poll(); <span class="comment">//将元素弹出</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//当队列没有元素可弹出时，将阻塞等待元素可用</span></span><br><span class="line"><span class="comment">//一秒后队列里还没有可弹出元素后就结束等待</span></span><br><span class="line"><span class="type">Object</span> <span class="variable">poll</span> <span class="operator">=</span> queue.poll(<span class="number">1</span>, TimeUnit.SECONDS);</span><br></pre></td></tr></table></figure></div>

<h5 id="element"><a href="#element" class="headerlink" title="element"></a>element</h5><p>获取队列首个元素，但不删除。若队列为空则抛出异常</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">BlockingQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>(<span class="number">3</span>);</span><br><span class="line"><span class="comment">// java.util.NoSuchElementException</span></span><br><span class="line"><span class="type">Object</span> <span class="variable">element</span> <span class="operator">=</span> queue.element();</span><br></pre></td></tr></table></figure></div>

<h5 id="peek"><a href="#peek" class="headerlink" title="peek"></a>peek</h5><p>获取队列首个元素，但不删除。若队列为空则返回null</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">BlockingQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>(<span class="number">3</span>);</span><br><span class="line"><span class="type">Object</span> <span class="variable">peek</span> <span class="operator">=</span> queue.peek();</span><br></pre></td></tr></table></figure></div>

<h5 id="put"><a href="#put" class="headerlink" title="put"></a>put</h5><p>往队列添加元素，若队列满了，则一直阻塞等待队列空出位置</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">BlockingQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>(<span class="number">3</span>);</span><br><span class="line">queue.put(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">queue.put(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">queue.put(<span class="string">&quot;3&quot;</span>);</span><br><span class="line"><span class="comment">//到这时，队列没位置了，所以会阻塞等待</span></span><br><span class="line">queue.put(<span class="string">&quot;4&quot;</span>);</span><br></pre></td></tr></table></figure></div>

<h5 id="take"><a href="#take" class="headerlink" title="take"></a>take</h5><p>获取并删除此队列的头部，若队列为空，则一直等待队列元素可用</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">BlockingQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>(<span class="number">3</span>);</span><br><span class="line"><span class="type">Object</span> <span class="variable">take</span> <span class="operator">=</span> queue.take();</span><br></pre></td></tr></table></figure></div>

<h3 id="SynchronousQueue-同步队列"><a href="#SynchronousQueue-同步队列" class="headerlink" title="SynchronousQueue 同步队列"></a>SynchronousQueue 同步队列</h3><p>没有容量，最多只能放一个元素，存放一个元素后必须等待这个元素被取出才能存放下一个元素</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">    <span class="type">SynchronousQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SynchronousQueue</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            queue.put(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;A &gt; PUT 1&quot;</span>);</span><br><span class="line">            queue.put(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">             System.out.println(<span class="string">&quot;A &gt; PUT 2&quot;</span>);</span><br><span class="line">            queue.put(<span class="string">&quot;3&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;A &gt; PUT 3&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;A&quot;</span>).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;B &gt; TAKE&quot;</span> + queue.take());</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;B &gt; TAKE&quot;</span> + queue.take());</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;B &gt; TAKE&quot;</span> + queue.take());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;B&quot;</span>).start();</span><br><span class="line"><span class="comment">//结果</span></span><br><span class="line">A &gt; PUT <span class="number">1</span></span><br><span class="line">B &gt; TAKE1</span><br><span class="line">A &gt; PUT <span class="number">2</span></span><br><span class="line">B &gt; TAKE2</span><br><span class="line">A &gt; PUT <span class="number">3</span></span><br><span class="line">B &gt; TAKE3</span><br></pre></td></tr></table></figure></div>
<p>上面例子可以看到，线程A存放元素后，必修等线程B把元素取出，线程A才能存放下一个元素</p>
<h3 id="线程池"><a href="#线程池" class="headerlink" title="线程池"></a>线程池</h3><blockquote>
<p>线程池是一个线程集合，需要执行新的任务时重用线程池里线程而不是新建线程。<br>特点是可以根据系统的需求和硬件环境灵活的控制线程的数量，且可以对所有线程进行统一的管理和控制，从而提高系统的运行效率，降低系统的运行压力</p>
</blockquote>
<h4 id="优势"><a href="#优势" class="headerlink" title="优势"></a>优势</h4><ul>
<li>降低资源消耗：线程和任务分离，提高线程重用性</li>
<li>控制线程并发数量，降低服务器压力，统一管理所有线程</li>
<li>提高系统响应速度。假如创建线程用的时间为T1，执行任务的时间为T2，销毁线程的时间为T3，那么使用线程池就免去了T1和T3的时间。</li>
</ul>
<h4 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h4><h5 id="使用-Executors-工具类创建线程池"><a href="#使用-Executors-工具类创建线程池" class="headerlink" title="使用 Executors 工具类创建线程池"></a>使用 Executors 工具类创建线程池</h5><p><mark style="background: #FFB86CA6;">以下三种方式不建议使用</mark>，</p>
<ul>
<li><code>newSingleThreadExecutor</code> 和 <code>newFixedThreadPool</code> 使用了一个无限大小的队列存放任务。任务可以一直提交过来，会导致OOM</li>
<li><code>newCachedThreadPool</code> 只会复用空闲线程，如果任务较多，且无空闲线程时就会创建新线程，如果任务无限多，线程也会无限多，会导致OOM<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//不建议使用以下三种方式</span></span><br><span class="line"><span class="comment">//单个线程</span></span><br><span class="line"><span class="type">ExecutorService</span> <span class="variable">executorService1</span> <span class="operator">=</span> Executors.newSingleThreadExecutor();</span><br><span class="line"><span class="comment">//固定个数个线程</span></span><br><span class="line"><span class="type">ExecutorService</span> <span class="variable">executorService2</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line"><span class="comment">//线程数量可伸缩，若线程超过60秒没用将会删除</span></span><br><span class="line"><span class="type">ExecutorService</span> <span class="variable">executorService3</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">//无返回值</span></span><br><span class="line">    executorService1.execute(() -&gt; &#123;</span><br><span class="line">        <span class="comment">//do something</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//有返回值</span></span><br><span class="line">     Future&lt;?&gt; submit = executorService1.submit(() -&gt; &#123;</span><br><span class="line">        <span class="comment">//do something</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;一个线程返回值&quot;</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//任务返回值</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> submit.get();</span><br><span class="line"> &#125; <span class="keyword">catch</span> (ExecutionException | InterruptedException e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">//关闭</span></span><br><span class="line">    executorService1.shutdown();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></li>
</ul>
<h5 id="自定义线程池"><a href="#自定义线程池" class="headerlink" title="自定义线程池"></a>自定义线程池</h5><ul>
<li>核心线程：线程执行完后保留在线程池中（可为0）</li>
<li>救急线程：线程执行完毕后不保留在线程池中。<mark style="background: #BBFABBA6;">当核心线程和任务队列都满载时，就会创建救急线程处理任务</mark></li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2023/04/08/cYJVz89S3PQuOTM.png"
                      alt="image.png"
                ></p>
<h6 id="核心参数"><a href="#核心参数" class="headerlink" title="核心参数"></a>核心参数</h6><ol>
<li>corePoolSize 核心线程数目，即最多保留的线程数</li>
<li>maximumPoolSize 最大线程数目，核心线程 + 救急线程</li>
<li>keepAliveTime 生存时间，针对救急线程，当<mark style="background: #D2B3FFA6;">救急线程空闲时间达到生存时间时就会去掉对应救急线程</mark></li>
<li>unit 时间单位，针对救急线程</li>
<li>workQueue 阻塞队列，<mark style="background: #ABF7F7A6;">起任务缓冲作用。当核心线程满载时，新任务会暂存在此队列</mark>中</li>
<li>threadFactory 线程工厂，可以为线程创建时起名</li>
<li>handler 拒绝策略，<mark style="background: #FFF3A3A6;">当核心线程，救急线程，任务队列都满载后。将触发拒绝策略</mark></li>
</ol>
<h6 id="拒绝策略"><a href="#拒绝策略" class="headerlink" title="拒绝策略"></a>拒绝策略</h6><ul>
<li>AbortPolicy（默认）：丢弃任务并抛出 RejectedExecutionException 异常。<ul>
<li>这是线程池默认的拒绝策略，在任务不能再提交的时候，抛出异常，及时反馈程序运行状态。如果是比较关键的业务，推荐使用此拒绝策略，这样子在系统不能承载更大的并发量的时候，能够及时的通过异常发现。</li>
</ul>
</li>
<li>CallerRunsPolicy：由调用线程处理该任务。<ul>
<li>如果任务被拒绝了，则由调用线程（提交任务的线程）直接执行此任务</li>
</ul>
</li>
<li>DiscardPolicy：丢弃任务，但是不抛出异常。可以配合这种模式进行自定义的处理方式。<ul>
<li> 使用此策略，可能会使我们无法发现系统的异常状态。建议是一些无关紧要的业务采用此策略。例如，某些视频网站统计视频的播放量就是采用的这种拒绝策略。</li>
</ul>
</li>
<li>DiscardOldestPolicy：丢弃队列最早的未处理任务，然后重新尝试执行任务。<ul>
<li>此拒绝策略，是一种喜新厌旧的拒绝策略。是否要采用此种拒绝策略，还得根据实际业务是否允许丢弃老任务来认真衡量</li>
</ul>
</li>
</ul>
<h6 id="自定义线程创建示例"><a href="#自定义线程创建示例" class="headerlink" title="自定义线程创建示例"></a>自定义线程创建示例</h6><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ThreadPoolExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">        <span class="number">4</span>, <span class="comment">// CorePoolSize</span></span><br><span class="line">        <span class="number">10</span>, <span class="comment">// MaximumPoolSize</span></span><br><span class="line">        <span class="number">0</span>, <span class="comment">// KeepAliveTime</span></span><br><span class="line">        TimeUnit.SECONDS, <span class="comment">//Unit</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">LinkedBlockingDeque</span>&lt;&gt;(<span class="number">10</span>), <span class="comment">// WorkQueue, 任务队列, 最多等待10个任务</span></span><br><span class="line">        Executors.defaultThreadFactory(), <span class="comment">// ThreadFactory 一般默认</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.AbortPolicy() <span class="comment">// Handler 拒绝策略</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure></div>

<h6 id="拓展"><a href="#拓展" class="headerlink" title="拓展"></a>拓展</h6><ul>
<li>最大线程数的定义<ul>
<li>CPU密集型：代码运行的服务器配置是几核，那么最大线程数就是几，使用 <code>Runtime.getRuntime().availableProcessors()</code> 获取操作系统的CPU数量</li>
<li>IO密集型：判断程序中需要操作IO的线程有几个，只要最大线程数大于这个值即可</li>
</ul>
</li>
</ul>
<h3 id="ForkJoin-分支合并"><a href="#ForkJoin-分支合并" class="headerlink" title="ForkJoin 分支合并"></a>ForkJoin 分支合并</h3><blockquote>
<p>ForkJoin是 Java7 提供了的一个用于并行执行任务的框架， 是一个把大任务分割成若干个小任务，最终汇总每个小任务结果后得到大任务结果的框架</p>
</blockquote>
<p>我们需要定义一个计算类，这里以求和运算做例子。定义一个计算类并继承 <code>RecursiveTask</code> 实现 <code>compute</code> 方法，当传入值之差小于 10_0000 时不做计算拆分，否则将折中拆开计算</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CalcTest</span> <span class="keyword">extends</span> <span class="title class_">RecursiveTask</span>&lt;Long&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Long start;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Long end;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CalcTest</span><span class="params">(Long start, Long end)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.start = start;</span><br><span class="line">        <span class="built_in">this</span>.end = end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Long <span class="title function_">compute</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ((end - start) &lt; <span class="number">10_0000</span>) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">result</span> <span class="operator">=</span> <span class="number">0L</span>;</span><br><span class="line">            System.out.println(<span class="string">&quot;&gt; 开始计算: start:&quot;</span> + start + <span class="string">&quot; - end:&quot;</span> + end);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">long</span> <span class="variable">i</span> <span class="operator">=</span> start; i &lt;= end; i++) &#123;</span><br><span class="line">                result += i;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">middle</span> <span class="operator">=</span> (start + end) / <span class="number">2</span>;</span><br><span class="line">            <span class="type">CalcTest</span> <span class="variable">calc1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CalcTest</span>(start, middle);</span><br><span class="line">            calc1.fork();</span><br><span class="line">            <span class="type">CalcTest</span> <span class="variable">calc2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CalcTest</span>(middle + <span class="number">1</span>, end);</span><br><span class="line">            calc2.fork();</span><br><span class="line">            <span class="keyword">return</span> calc1.join() + calc2.join();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用方法</span></span><br><span class="line"><span class="type">CalcTest</span> <span class="variable">calcTest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CalcTest</span>(<span class="number">1L</span>, <span class="number">10_0000_0000L</span>);</span><br><span class="line"><span class="comment">//创建ForkJoinPool 线程池</span></span><br><span class="line"><span class="type">ForkJoinPool</span> <span class="variable">forkJoinPool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ForkJoinPool</span>();</span><br><span class="line"><span class="comment">//提交计算任务</span></span><br><span class="line">ForkJoinTask&lt;Long&gt; submit = forkJoinPool.submit(calcTest);</span><br><span class="line"><span class="comment">//获取计算结果</span></span><br><span class="line">submit.get();</span><br></pre></td></tr></table></figure></div>
<p>尴尬的是，本人电脑计算这个求和运算，传统for循环累加和ForkJoin的运行时间只相差10毫秒</p>
<h4 id="Stream的并行流"><a href="#Stream的并行流" class="headerlink" title="Stream的并行流"></a>Stream的并行流</h4><p>当然我们也可以使用Stream的并行流来计算，<code>IntStream</code> <code>LongStream</code> <code>DoubleStream</code>  这里以计算Long类型的数为例。下面这行代码实现了并行求和，且运行时间仅用了 <code>89毫秒</code>，</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="variable">reduce</span> <span class="operator">=</span> LongStream.rangeClosed(<span class="number">0L</span>, <span class="number">10_0000_0000</span>).parallel().reduce(<span class="number">0</span>, Long::sum);</span><br></pre></td></tr></table></figure></div>
<ul>
<li>parallel：返回自身的并行流</li>
<li>reduce：根据计算值得到一个最终结果</li>
</ul>
<h3 id="异步回调"><a href="#异步回调" class="headerlink" title="异步回调"></a>异步回调</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//无返回值</span></span><br><span class="line">CompletableFuture&lt;Void&gt; comp = CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;异步线程进入&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;异步线程结束&quot;</span>);</span><br><span class="line">&#125;, executor);<span class="comment">//executor 线程池</span></span><br><span class="line"><span class="comment">//有返回值</span></span><br><span class="line"></span><br><span class="line">CompletableFuture&lt;Integer&gt; comp = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;异步线程进入&quot;</span>);</span><br><span class="line">    <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">1</span> / <span class="number">0</span>;</span><br><span class="line">    System.out.println(<span class="string">&quot;异步线程结束&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">233</span>;</span><br><span class="line">&#125;, executor);</span><br><span class="line"><span class="type">Integer</span> <span class="variable">integer</span> <span class="operator">=</span> comp</span><br><span class="line">		<span class="comment">//当异步任务成功后</span></span><br><span class="line">        .whenComplete((v, e) -&gt; &#123; <span class="comment">//v 返回值 | e 异常信息</span></span><br><span class="line">            System.out.println(v);</span><br><span class="line">            System.out.println(<span class="string">&quot;exception1: &quot;</span> + e);</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">//当异步任务失败后</span></span><br><span class="line">        .exceptionally(e -&gt; &#123;</span><br><span class="line">		    <span class="comment">//e 是异常信息</span></span><br><span class="line">            System.out.println(<span class="string">&quot;exception2: &quot;</span> + e);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>; <span class="comment">//执行失败后返回</span></span><br><span class="line">        &#125;)</span><br><span class="line">        .get(); <span class="comment">// 此次任务的返回值</span></span><br><span class="line">System.out.println(integer); <span class="comment">// 没有报错是 233 | 报错是1</span></span><br></pre></td></tr></table></figure></div>

<p>个人觉得有点像 JS 的 <code>Promise</code></p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">service</span>()</span><br><span class="line">	.<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">	&#125;)</span><br><span class="line">	.<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">	&#125;)</span><br></pre></td></tr></table></figure></div>

<h3 id="JMM"><a href="#JMM" class="headerlink" title="JMM"></a>JMM</h3><blockquote>
<p>Java内存模型，一种概念，并不真实存在。用来屏蔽各种硬件和操作系统的内存访问差异，以实现让Java程序在各种平台下都能达到一致的内存访问效果。关键技术点围绕多线程的<mark style="background: #FFB86CA6;">原子性</mark>，<mark style="background: #ABF7F7A6;">可见性</mark>，<mark style="background: #FFF3A3A6;">有序性</mark> 展开</p>
</blockquote>
<p>JMM规定所有的变量都存储在主内存中。每条线程都有自己的工作内存，存放该线程的工作中使用的变量副本，线程对变量的操作（读，写）都必须在自己的工作内存中进行，不能直接操作主内存中的数据。每个线程只能访问自己的工作内存，不能访问其他线程的工作内存。线程之间的变量传递通过主内存来进行。</p>
<p>JMM中定义了8种工作内存与主内存之间的原子操作<br><code>read(读取) &gt; load(加载) &gt; use(使用)&gt; assign(赋值) &gt; store(存储) &gt; write(写入) &gt; lock(锁定) &gt; unlock(解锁)</code></p>
<ul>
<li>read:作用于主内存，将变量的值从主内存传输到工作内存，主内存到工作内存</li>
<li>load:作用于工作内存，将read从主内存传输的变量值放入工作内存变量副本中，即数据加载</li>
<li>use:作用于工作内存，将工作内存变量副本的值传递给执行引擎，每当JVM遇到需要该变量的字节码指令时会执行该操作</li>
<li>assign:作用于工作内存，将从执行引擎接收到的值赋值给工作内存变量，每当JVM遇到一个给变量赋值字节码指令时会执行该操作</li>
<li>store:作用于工作内存，将赋值完毕的工作变量的值写回给主内存</li>
<li>write:作用于主内存，将store传输过来的变量值赋值给主内存中的变量</li>
<li>lock:作用于主内存，将一个变量标记为一个线程独占的状态，只是写时候加锁，就只是锁了写变量的过程。</li>
<li>unlock:作用于主内存，把一个处于锁定状态的变量释放，然后才能被其他线程占用</li>
</ul>
<h4 id="volatile"><a href="#volatile" class="headerlink" title="volatile"></a>volatile</h4><blockquote>
<p>jdk的关键字，保证可见性，不保证原子性，对内存随机访问操作的一个同步点，使得此点之前的所有读写操作都执行后才可以开始执行此点之后的操作，避免指令重排</p>
</blockquote>
<h5 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h5><ul>
<li>保证可见性：用volatile声明一个变量。当一个线程修改这个变量的数据后，其他线程可以及时知道</li>
<li>禁止指令重排序优化：在复制操作时不能保证变量赋值操作的顺序与代码中的执行顺序一致，而volatile防止指令重排</li>
</ul>
<h5 id="例子解析"><a href="#例子解析" class="headerlink" title="例子解析"></a>例子解析</h5><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//没有 volatile 的情况</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Test12</span> <span class="variable">instance</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 双检索懒汉式单例</span></span><br><span class="line"><span class="comment">  * 假设它在高并发下被使用</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Test12 <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123; <span class="comment">// 第一重判断</span></span><br><span class="line">        <span class="keyword">synchronized</span> (Test12.class) &#123;</span><br><span class="line">            <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123; <span class="comment">// 第二重判断</span></span><br><span class="line">                <span class="comment">// new对象时是开辟内存空间，初始化对象，然后指向</span></span><br><span class="line">                <span class="comment">//但为了提高性能，编译器和处理器常常会对既定的代码执行顺序进行指令重排序。</span></span><br><span class="line">                <span class="comment">//重排序后执行有可能变成开辟空间，然后指向，再初始化对象</span></span><br><span class="line">                <span class="comment">//这样做在单线程下是没有问题的，但是如果此时有另外一个线程进来，它在第一重判断，判断到instance已经有指向的对象了。就直接返回。但此时的instance还未初始化</span></span><br><span class="line">                instance = <span class="keyword">new</span> <span class="title class_">Test12</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>以上面代码为例子，new一个对象的过程大概是开辟内存空间，初始化对象，然后指向。但为了提高性能，编译器和处理器常常会对既定的代码执行顺序进行指令重排序。重排序后执行有可能变成开辟空间，然后指向，再初始化对象。这样做在单线程下是没有问题的，但是如果此时有另外一个线程进来，它在第一重判断，判断到instance已经有指向的对象了。就直接返回。但此时的instance是个半成品有空指针异常</li>
<li>使用 volatile</li>
</ul>
<h3 id="CAS-比较并交换"><a href="#CAS-比较并交换" class="headerlink" title="CAS 比较并交换"></a>CAS 比较并交换</h3><blockquote>
<p>CAS 操作包含三个操作数 —— 内存位置（V）、预期原值（A）和新值(B)。 如果内存位置的值与预期原值相匹配，那么处理器会自动将该位置值更新为新值 。否则，处理器不做任何操作。</p>
<p>Java的CAS是sun.misc.UnSaffe类中的各个方法。<mark style="background: #FFF3A3A6;">调用UnSafe类中的CAS方法，JVM会帮我们实现CAS汇编指令，完全依赖于硬件功能，通过它实现了原子操作</mark>，由于CAS是一种系统原语，原语属于操作系统范畴，是由若干条指令组成，用于完成某个功能的一个过程，并且原语的执行必须是连续的，在执行过程中不允许中断，也即是说CAS是一条原子指令，不会造成数据不一致的问题。</p>
</blockquote>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">AtomicInteger</span> <span class="variable">integer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">10</span>);</span><br><span class="line"><span class="comment">//10 是期望原值 &gt; A | 12是新值 &gt; B</span></span><br><span class="line">System.out.println(integer.compareAndSet(<span class="number">10</span>, <span class="number">12</span>)); <span class="comment">//true</span></span><br><span class="line">System.out.println(integer.get()); <span class="comment">// 12</span></span><br><span class="line"></span><br><span class="line">System.out.println(integer.compareAndSet(<span class="number">11</span>, <span class="number">12</span>)); <span class="comment">// false</span></span><br><span class="line">System.out.println(integer.get()); <span class="comment">//10</span></span><br></pre></td></tr></table></figure></div>
<h4 id="CAS的缺点"><a href="#CAS的缺点" class="headerlink" title="CAS的缺点"></a>CAS的缺点</h4><ul>
<li>循环时间长开销很大：Java的CAS底层是自旋锁，在并发量比较高的情况下，如果许多线程反复尝试更新某一个变量，却又一直更新不成功，循环往复，会给CPU带来很大的压力。</li>
<li>只能保证一个共享变量的原子性：当对一个共享变量执行操作时，我们可以使用CAS的方式来保证原子操作，但是对多个共享变量操作时，CAS就无法保证操作的原子性。</li>
<li>ABA问题：一个线程把数据A变成了B，然后又重新变成了A，此时另一个线程读取该数据的时候，发现A没有变化，就误认为是原来的那个A，但是此时A的一些属性或状态已经发生过变化。</li>
</ul>
<h4 id="ABA问题"><a href="#ABA问题" class="headerlink" title="ABA问题"></a>ABA问题</h4><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">CASData</span> <span class="variable">d1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CASData</span>(<span class="string">&quot;A1&quot;</span>, <span class="number">12</span>);</span><br><span class="line"><span class="type">CASData</span> <span class="variable">d2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CASData</span>(<span class="string">&quot;B1&quot;</span>, <span class="number">15</span>);</span><br><span class="line"><span class="type">CASData</span> <span class="variable">d3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CASData</span>(<span class="string">&quot;C1&quot;</span>, <span class="number">17</span>);</span><br><span class="line"></span><br><span class="line">AtomicReference&lt;CASData&gt; i1 = <span class="keyword">new</span> <span class="title class_">AtomicReference</span>&lt;&gt;(d1);</span><br><span class="line"><span class="comment">//线程A把i1的值变成d2，然后修改d1的值后又把i1变回d1</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    i1.compareAndSet(d1,d2);</span><br><span class="line">    </span><br><span class="line">    d1.setName(<span class="string">&quot;B2&quot;</span>);</span><br><span class="line">    d1.setValue(<span class="number">13</span>);</span><br><span class="line">    i1.compareAndSet(d2,d1);</span><br><span class="line">&#125;).start();</span><br><span class="line"><span class="comment">//线程B不知道线程A的操作，线程B还以为d1 还是原来的那个d1 -&gt; [A1,12],但实际上d1已经变成了 [B2,13]</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(i1.compareAndSet(d1,d3));</span><br><span class="line">    System.out.println(i1.get());</span><br><span class="line">&#125;).start();</span><br></pre></td></tr></table></figure></div>

<h5 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h5><p>增加一个版本号，当内存位置V的值每次被修改后，版本号都加1</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">CASData</span> <span class="variable">d1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CASData</span>(<span class="string">&quot;A1&quot;</span>, <span class="number">12</span>);</span><br><span class="line">        <span class="type">CASData</span> <span class="variable">d2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CASData</span>(<span class="string">&quot;B1&quot;</span>, <span class="number">15</span>);</span><br><span class="line">        <span class="type">CASData</span> <span class="variable">d3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CASData</span>(<span class="string">&quot;C1&quot;</span>, <span class="number">17</span>);</span><br><span class="line"></span><br><span class="line">        AtomicStampedReference&lt;CASData&gt; i1 = <span class="keyword">new</span> <span class="title class_">AtomicStampedReference</span>&lt;&gt;(d1, <span class="number">1</span>);</span><br><span class="line">		<span class="comment">//线程A</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            System.out.println(i1.compareAndSet(d1, d2, i1.getStamp(), i1.getStamp() + <span class="number">1</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;A1 &gt; &quot;</span> + i1.getStamp());</span><br><span class="line">            d1.setName(<span class="string">&quot;B2&quot;</span>);</span><br><span class="line">            d1.setValue(<span class="number">13</span>);</span><br><span class="line">            System.out.println(i1.compareAndSet(d2, d1, i1.getStamp(), i1.getStamp() + <span class="number">1</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;B1 &gt; &quot;</span> + i1.getStamp());</span><br><span class="line">        &#125;).start();</span><br><span class="line">        <span class="comment">//线程B</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">stamp</span> <span class="operator">=</span> i1.getStamp(); <span class="comment">// 版本号获取到1</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(i1.compareAndSet(d1, d3, stamp, i1.getStamp() + <span class="number">1</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;C1 &gt; &quot;</span> + i1.getStamp());</span><br><span class="line">            System.out.println(<span class="string">&quot;d1 &gt; &quot;</span> + i1.getReference());</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//结果</span></span><br><span class="line"><span class="comment">//线程A进行ABA修改</span></span><br><span class="line"><span class="literal">true</span>   <span class="comment">//d1 -&gt; d2 成功</span></span><br><span class="line">A1 &gt; <span class="number">2</span> <span class="comment">//版本号 + 1</span></span><br><span class="line"><span class="literal">true</span>   <span class="comment">//d2 -&gt; d1 成功</span></span><br><span class="line">B1 &gt; <span class="number">3</span> <span class="comment">//版本号 + 1</span></span><br><span class="line"><span class="comment">//线程B修改失败，因为版本号不一致</span></span><br><span class="line"><span class="literal">false</span>  <span class="comment">//d1 -&gt; d3 失败</span></span><br><span class="line">C1 &gt; <span class="number">3</span> <span class="comment">//此时线程B持有的版本号是1</span></span><br><span class="line">d1 &gt; CASData&#123;name=<span class="string">&#x27;B2&#x27;</span>, value=<span class="number">13</span>&#125;</span><br></pre></td></tr></table></figure></div>

<p>使用 <code>AtomicStampedReference</code> 维护的 <code>stamp</code> 属性来进行版本号更新操作。每一次修改值后 <code>stamp</code> 都 + 1</p>
<h3 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h3><blockquote>
<p>多个线程同时被阻塞，它们中的一个或者全部都在等待某个资源被释放。由于线程被无限期地阻塞，因此程序不可能正常终止。</p>
</blockquote>
<h4 id="死锁产生的四个必要条件："><a href="#死锁产生的四个必要条件：" class="headerlink" title="死锁产生的四个必要条件："></a>死锁产生的四个必要条件：</h4><ol>
<li>互斥使用，即当资源被一个线程使用(占有)时，别的线程不能使用</li>
<li>不可抢占，资源请求者不能强制从资源占有者手中夺取资源，资源只能由资源占有者主动释放。</li>
<li>请求和保持，即当资源请求者在请求其他的资源的同时保持对原有资源的占有。</li>
<li>循环等待，即存在一个等待队列：P1占有P2的资源，P2占有P3的资源，P3占有P1的资源。这样就形成了一个等待环路<br>以上4个条件成立便会产生死锁，而打破上述条件其中一个就可让死锁消失。</li>
</ol>
<p>以下是死锁产生的案例，A和B两个线程都要锁住一个以上对象</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">lock1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">lock2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (Test13.lock1) &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">            <span class="keyword">synchronized</span> (Test13.lock2) &#123;</span><br><span class="line">                TimeUnit.MINUTES.sleep(<span class="number">60</span>); <span class="comment">//测试，资源占用后不释放</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;A&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (Test13.lock2) &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">            <span class="keyword">synchronized</span> (Test13.lock1) &#123;</span><br><span class="line">                TimeUnit.MINUTES.sleep(<span class="number">60</span>); <span class="comment">//测试，资源占用后不释放</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;B&quot;</span>).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="死锁排查"><a href="#死锁排查" class="headerlink" title="死锁排查"></a>死锁排查</h4><p>使用 <code>jps</code> 命令查看Java进程id，然后使用 <code>jstack 进程id</code> 可以查看Java的堆栈信息，如下<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2023/04/14/TfPtvSrs1WleBVI.png"
                      alt="image.png"
                ><br>可以看到，堆栈信息提示找到了一个死锁，如果是在IDEA里使用该命令，我们还可以直接跳转到对应的代码。</p>

            </div>

            

            
                <ul class="post-tags-box">
                    
                        <li class="tag-item">
                            <a href="/tags/java/">#java</a>&nbsp;
                        </li>
                    
                        <li class="tag-item">
                            <a href="/tags/note/">#note</a>&nbsp;
                        </li>
                    
                        <li class="tag-item">
                            <a href="/tags/thread/">#thread</a>&nbsp;
                        </li>
                    
                        <li class="tag-item">
                            <a href="/tags/concurrent/">#concurrent</a>&nbsp;
                        </li>
                    
                </ul>
            

            

            
                <div class="article-nav">
                    
                        <div class="article-prev">
                            <a class="prev"
                            rel="prev"
                            href="/git/Git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"
                            >
                                <span class="left arrow-icon flex-center">
                                    <i class="fa-solid fa-chevron-left"></i>
                                </span>
                                <span class="title flex-center">
                                    <span class="post-nav-title-item">Git学习笔记</span>
                                    <span class="post-nav-item">Prev posts</span>
                                </span>
                            </a>
                        </div>
                    
                    
                        <div class="article-next">
                            <a class="next"
                            rel="next"
                            href="/html/React%E7%AC%94%E8%AE%B0/"
                            >
                                <span class="title flex-center">
                                    <span class="post-nav-title-item">React笔记</span>
                                    <span class="post-nav-item">Next posts</span>
                                </span>
                                <span class="right arrow-icon flex-center">
                                    <i class="fa-solid fa-chevron-right"></i>
                                </span>
                            </a>
                        </div>
                    
                </div>
            


            
        </div>

        
            <div class="toc-content-container">
                <div class="post-toc-wrap">
    <div class="post-toc">
        <div class="toc-title">On this page</div>
        <div class="page-title">并发笔记</div>
        <ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E6%B3%95"><span class="nav-text">使用线程的几种方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E7%9A%84%E7%8A%B6%E6%80%81"><span class="nav-text">线程的状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%8A%B6%E6%80%81%E5%88%87%E6%8D%A2"><span class="nav-text">状态切换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"><span class="nav-text">常见问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Lock%E4%B8%8Esynchronized"><span class="nav-text">Lock与synchronized</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%9F%E4%BA%A7%E8%80%85%E5%92%8C%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98"><span class="nav-text">生产者和消费者问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E5%90%88%E7%B1%BB%E4%B8%8D%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98"><span class="nav-text">集合类不安全问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Callable%E6%8E%A5%E5%8F%A3"><span class="nav-text">Callable接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E8%BE%85%E5%8A%A9%E7%B1%BB"><span class="nav-text">常用辅助类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ReadWriteLock-%E8%AF%BB%E5%86%99%E9%94%81"><span class="nav-text">ReadWriteLock 读写锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BlockingQueue-%E9%98%BB%E5%A1%9E%E9%98%9F%E5%88%97"><span class="nav-text">BlockingQueue 阻塞队列</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SynchronousQueue-%E5%90%8C%E6%AD%A5%E9%98%9F%E5%88%97"><span class="nav-text">SynchronousQueue 同步队列</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="nav-text">线程池</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ForkJoin-%E5%88%86%E6%94%AF%E5%90%88%E5%B9%B6"><span class="nav-text">ForkJoin 分支合并</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%82%E6%AD%A5%E5%9B%9E%E8%B0%83"><span class="nav-text">异步回调</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JMM"><span class="nav-text">JMM</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CAS-%E6%AF%94%E8%BE%83%E5%B9%B6%E4%BA%A4%E6%8D%A2"><span class="nav-text">CAS 比较并交换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AD%BB%E9%94%81"><span class="nav-text">死锁</span></a></li></ol>

    </div>
</div>
            </div>
        
    </div>
</div>


                

            </div>
            
            

        </div>

        <div class="main-content-footer">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info">
            &copy;
            
              <span>2022</span>
              -
            
            2023&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">kita17</a>
        </div>
        
            <script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv" class="busuanzi_container_site_uv">
                        VISITOR COUNT&nbsp;<span id="busuanzi_value_site_uv" class="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="busuanzi_container_site_pv">
                        TOTAL PAGE VIEWS&nbsp;<span id="busuanzi_value_site_pv" class="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            <span class="powered-by-container">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" href="https://hexo.io">Hexo</a></span>
                <br>
            <span class="theme-version-container">THEME&nbsp;<a class="theme-version" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.1.5</a>
        </div>
        
        
        
        
        
        
        
    </div>  
</footer>
        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="article-tools-list">
        <!-- TOC aside toggle -->
        
            <li class="right-bottom-tools page-aside-toggle">
                <i class="fa-regular fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-side-tools-container">
        <div class="side-tools-container">
    <ul class="hidden-tools-list">
        <li class="right-bottom-tools tool-font-adjust-plus flex-center">
            <i class="fa-regular fa-magnifying-glass-plus"></i>
        </li>

        <li class="right-bottom-tools tool-font-adjust-minus flex-center">
            <i class="fa-regular fa-magnifying-glass-minus"></i>
        </li>

        <li class="right-bottom-tools tool-expand-width flex-center">
            <i class="fa-regular fa-expand"></i>
        </li>

        <li class="right-bottom-tools tool-dark-light-toggle flex-center">
            <i class="fa-regular fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="right-bottom-tools tool-scroll-to-bottom flex-center">
            <i class="fa-regular fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="visible-tools-list">
        <li class="right-bottom-tools toggle-tools-list flex-center">
            <i class="fa-regular fa-cog fa-spin"></i>
        </li>
        
            <li class="right-bottom-tools tool-scroll-to-top flex-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
        
    </ul>
</div>

    </div>

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fa-solid fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fa-solid fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    


</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/layouts/navbarShrink.js"></script>

<script src="/js/tools/scrollTopBottom.js"></script>

<script src="/js/tools/lightDarkSwitch.js"></script>



    
<script src="/js/tools/localSearch.js"></script>




    
<script src="/js/tools/codeBlock.js"></script>




    
<script src="/js/layouts/lazyload.js"></script>






  
<script src="/js/libs/Typed.min.js"></script>

  
<script src="/js/plugins/typed.js"></script>







<div class="post-scripts pjax">
    
        
<script src="/js/tools/tocToggle.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/layouts/toc.js"></script>

<script src="/js/plugins/tabs.js"></script>

    
</div>


    
<script src="/js/libs/pjax.min.js"></script>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax',
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            Global.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            Global.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            Global.refresh();
        });
    });
</script>




</body>
</html>
