<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="kita17">
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    
    <!--- Seo Part-->
    
    <link rel="canonical" href="http://kita-17.github.io/mysql-note/mysql笔记2/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
        <meta name="description" content="Mysql的体系结构  连接层：最上层时一些客户端和链接服务，主要完成连接处理，授权认证，以及相关的安全方案。回味安全连接的每个用户验证操作权限 服务层：服务层主要完成核心服务功能，如SQL接口，SQL分析和优化。缓存的查询，部分内置函数的执行等。所有跨存储引擎的功能也是在服务层实现的。如过程，函数等。 引擎层：存储引擎真正负责mysql中数据的存储和提取，服务器通过API和引擎通信。不同引擎有不">
<meta property="og:type" content="article">
<meta property="og:title" content="Mysql笔记2">
<meta property="og:url" content="http://kita-17.github.io/mysql-note/mysql%E7%AC%94%E8%AE%B02/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Mysql的体系结构  连接层：最上层时一些客户端和链接服务，主要完成连接处理，授权认证，以及相关的安全方案。回味安全连接的每个用户验证操作权限 服务层：服务层主要完成核心服务功能，如SQL接口，SQL分析和优化。缓存的查询，部分内置函数的执行等。所有跨存储引擎的功能也是在服务层实现的。如过程，函数等。 引擎层：存储引擎真正负责mysql中数据的存储和提取，服务器通过API和引擎通信。不同引擎有不">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://image-static.segmentfault.com/704/443/704443246-60595802ee830">
<meta property="og:image" content="https://s2.loli.net/2023/03/20/9TqtFO13sbgy5Zf.png">
<meta property="og:image" content="https://s2.loli.net/2023/03/20/B1mtrnyYHTWSZQG.png">
<meta property="og:image" content="https://s2.loli.net/2023/03/20/tAVrYp7WgPxu3nw.png">
<meta property="og:image" content="https://s2.loli.net/2023/03/20/raWdfNLt4y5kKzR.png">
<meta property="og:image" content="https://s2.loli.net/2023/03/20/dGUhZD73VXmWTzL.png">
<meta property="og:image" content="https://s2.loli.net/2023/03/20/bXtld4hJTY3OCrx.png">
<meta property="og:image" content="https://s2.loli.net/2023/03/22/kQvb3GMrU16wtSy.png">
<meta property="og:image" content="https://s2.loli.net/2023/03/22/DNg3t7ICrcEke8K.png">
<meta property="og:image" content="https://s2.loli.net/2023/03/22/cL25e4OaKhtSDz9.png">
<meta property="og:image" content="https://s2.loli.net/2023/03/22/djlzIMOEHypLv7g.png">
<meta property="og:image" content="https://s2.loli.net/2023/03/24/VlFQhOdW3TmkERn.png">
<meta property="og:image" content="https://dev.mysql.com/doc/refman/8.0/en/images/innodb-architecture-8-0.png">
<meta property="og:image" content="https://s2.loli.net/2023/03/24/CWXGHETSdtfqzgV.png">
<meta property="og:image" content="https://s2.loli.net/2023/03/24/5Duo2kKPCUjfLv9.png">
<meta property="article:published_time" content="2022-09-30T16:00:00.000Z">
<meta property="article:modified_time" content="2023-03-24T09:18:14.402Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="note">
<meta property="article:tag" content="mysql">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://image-static.segmentfault.com/704/443/704443246-60595802ee830">
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/images/logo.png" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.png">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="/images/logo.png">
    <!--- Page Info-->
    
    <title>
        
            Mysql笔记2 -
        
        KITA!!
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
<link rel="stylesheet" href="/assets/fonts.css">

    <!--- Font Part-->
    
    
        <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@500&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    
    
    

    <!--- Inject Part-->
    
    <script id="hexo-configurations">
    let Global = window.Global || {};
    Global.hexo_config = {"hostname":"kita-17.github.io","root":"/","language":"en","path":"search.xml"};
    Global.theme_config = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":true,"auto":false,"list":[""]},"code_block":{"copy":true,"style":"simple","font":{"enable":true,"family":"Fira Code","url":"https://fonts.googleapis.com/css2?family=Fira+Code:wght@500&family=JetBrains+Mono:wght@500&display=swap"}},"toc":{"enable":true,"max_depth":3,"number":false,"expand":true,"init_open":true},"copyright":false,"lazyload":true,"recommendation":{"enable":false,"title":"推荐阅读","limit":3,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":null},"global":{"fonts":{"chinese":{"enable":false,"family":null,"url":null},"english":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":true},"scroll_progress":{"bar":false,"percentage":true},"busuanzi_counter":{"enable":true,"site_pv":true,"site_uv":true,"post_pv":true},"pjax":true,"open_graph":true,"google_analytics":{"enable":false,"id":null}},"home_banner":{"enable":true,"style":"static","image":{"light":"/images/banner-light.png","dark":"/images/banner-dark.png"},"title":"KITA KITA!!","subtitle":{"text":[],"hitokoto":{"enable":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#fff","dark":"#d1d1b6"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":false,"links":{"github":"https://github.com/kita-17","instagram":null,"zhihu":null,"twitter":null,"email":null}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null}]},"mermaid":{"enable":false,"version":"9.3.0"}},"version":"2.1.5","navbar":{"auto_hide":false,"color":{"left":"#f78736","right":"#367df7","transparency":35},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"Archives":{"path":"/archives","icon":"fa-regular fa-archive"},"Tags":{"icon":"fa-regular fa-tag","path":"/tags"},"Categories":{"icon":"fa-regular fa-book","path":"/categories"}},"search":{"enable":true,"preload":true}},"page_templates":{"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":null,"links":{"Archives":{"path":"/archives","icon":"fa-regular fa-archive"},"Tags":{"path":"/tags","icon":"fa-regular fa-tags"},"Categories":{"path":"/categories","icon":"fa-regular fa-folder"}}},"article_date_format":"auto","categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}}};
    Global.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
    Global.data_config = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
<div class="progress-bar-container">
    

    
        <span class="pjax-progress-bar"></span>
        <span class="pjax-progress-icon">
            <i class="fa-solid fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container">

    

    <div class="main-content-container">

        <div class="main-content-header">
            <header class="navbar-container">
    
    <div class="navbar-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                KITA!!
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/"  >
                                    
                                        
                                            <i class="fa-regular fa-house"></i>
                                        
                                        HOME
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/archives"  >
                                    
                                        
                                            <i class="fa-regular fa-archive"></i>
                                        
                                        ARCHIVES
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/tags"  >
                                    
                                        
                                            <i class="fa-regular fa-tag"></i>
                                        
                                        TAGS
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/categories"  >
                                    
                                        
                                            <i class="fa-regular fa-book"></i>
                                        
                                        CATEGORIES
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                    
                        <li class="navbar-item search search-popup-trigger">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </li>
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i></div>
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile drawer -->
    <div class="navbar-drawer">
        <ul class="drawer-navbar-list">
            
                
                    <li class="drawer-navbar-item flex-center">
                        <a class="" 
                        href="/"  >
                             
                                
                                    <i class="fa-regular fa-house"></i>
                                
                                HOME
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item flex-center">
                        <a class="" 
                        href="/archives"  >
                             
                                
                                    <i class="fa-regular fa-archive"></i>
                                
                                ARCHIVES
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item flex-center">
                        <a class="" 
                        href="/tags"  >
                             
                                
                                    <i class="fa-regular fa-tag"></i>
                                
                                TAGS
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item flex-center">
                        <a class="" 
                        href="/categories"  >
                             
                                
                                    <i class="fa-regular fa-book"></i>
                                
                                CATEGORIES
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            

        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="main-content-body">

            

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="post-page-container">
        <div class="article-content-container">

            
            
                <div class="article-title">
                    <h1 class="article-title-regular">Mysql笔记2</h1>
                </div>
            
                
            

            
                <div class="article-header">
                    <div class="avatar">
                        <img src="/images/avatar.png">
                    </div>
                    <div class="info">
                        <div class="author">
                            <span class="name">kita17</span>
                            
                                <span class="author-label"></span>
                            
                        </div>
                        <div class="meta-info">
                            <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2022-10-01</span>
        <span class="mobile">2022-10-01 00</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2023-03-24 17:18:14</span>
            <span class="mobile">2023-03-24 17:18</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
        <span class="article-categories article-meta-item">
            <i class="fa-regular fa-folders"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/note/">note</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/note/">note</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/mysql/">mysql</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                        </div>
                    </div>
                </div>
            

            <div class="article-content markdown-body">
                <h2 id="Mysql的体系结构"><a href="#Mysql的体系结构" class="headerlink" title="Mysql的体系结构"></a>Mysql的体系结构</h2><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://image-static.segmentfault.com/704/443/704443246-60595802ee830"
                     
                ></p>
<ul>
<li>连接层：最上层时一些客户端和链接服务，主要完成连接处理，授权认证，以及相关的安全方案。回味安全连接的每个用户验证操作权限</li>
<li>服务层：服务层主要完成核心服务功能，如SQL接口，SQL分析和优化。缓存的查询，部分内置函数的执行等。所有跨存储引擎的功能也是在服务层实现的。如过程，函数等。</li>
<li>引擎层：存储引擎真正负责mysql中数据的存储和提取，服务器通过API和引擎通信。不同引擎有不同的功能。<mark style="background: #ADCCFFA6;">不同的引擎其索引结构也不同</mark></li>
<li>存储层：主要将数据存储在文件系统上，并与引擎进行交互</li>
</ul>
<h2 id="存储引擎"><a href="#存储引擎" class="headerlink" title="存储引擎"></a>存储引擎</h2><blockquote>
<p>存储引擎就是<mark style="background: #FFF3A3A6;">存储数据</mark>、<mark style="background: #BBFABBA6;">建立索引</mark>、<mark style="background: #FFB86CA6;">更新&#x2F;查询数据</mark>等技术的实现方式。<mark style="background: #D2B3FFA6;">存储引擎是基于表的，而不是基于库的</mark>，所以存储引擎也可以被成为表的类型<br>mysql默认存储引擎是 <mark style="background: #ADCCFFA6;">InnoDB</mark></p>
</blockquote>
<p>创建表时指定存储引擎 <code>CREATE TABLE 表名(字段信息...) ENGINE=引擎名(默认InnoDB) 其他设置...</code><br>通过指令 <code>SHOW ENGINES;</code> 查看当前数据库支持的存储引擎，结果如下</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2023/03/20/9TqtFO13sbgy5Zf.png"
                      alt="image.png"
                ></p>
<h3 id="常见的三个引擎特点"><a href="#常见的三个引擎特点" class="headerlink" title="常见的三个引擎特点"></a>常见的三个引擎特点</h3><p><strong>mysql常见常用的存储引擎有三种，分别是</strong> <code>InnoDB</code> 、<code>MyISAM</code> <strong>和</strong> <code>MEMORY</code></p>
<h4 id="InnoDB"><a href="#InnoDB" class="headerlink" title="InnoDB"></a>InnoDB</h4><blockquote>
<p>是一种兼顾高可靠性和高性能的通用存储引擎</p>
</blockquote>
<ul>
<li>特点<ul>
<li>DML操作遵循ACID模型，支持事务</li>
<li>行级锁，提高并发访问性能</li>
<li>支持外键 <code>FOREIGN KEY</code> 约束，保证数据完整和正确</li>
</ul>
</li>
<li>文件<ul>
<li>xxx.ibd 其中xxx是表名，InnoDB的每一张表都会有对应的表空间文件来存储该表的表结构（frm、sdi）、数据和索引</li>
</ul>
</li>
</ul>
<h4 id="MyISAM"><a href="#MyISAM" class="headerlink" title="MyISAM"></a>MyISAM</h4><blockquote>
<p>mysql早期的默认存储引擎</p>
</blockquote>
<ul>
<li>特点<ul>
<li>不支持事务，不支持外键</li>
<li>支持表锁，不支持行锁</li>
<li>访问速度快</li>
</ul>
</li>
<li>文件<ul>
<li>xxx.MYD：存放表中的数据</li>
<li>xxx.MYI：存储索引</li>
<li>xxx.sdi：存放表结构</li>
</ul>
</li>
</ul>
<h4 id="Memory"><a href="#Memory" class="headerlink" title="Memory"></a>Memory</h4><blockquote>
<p>表数据存储在内存中，但由于内存断电数据就没了，所以只能将这些表做临时表或缓存使用</p>
</blockquote>
<ul>
<li>特点<ul>
<li>数据存在内存中吗，访问速度最快</li>
<li>hash索引（默认）</li>
</ul>
</li>
<li>文件<ul>
<li>xxx.sdi：存放表结构</li>
</ul>
</li>
</ul>
<h3 id="存储引擎的选择"><a href="#存储引擎的选择" class="headerlink" title="存储引擎的选择"></a>存储引擎的选择</h3><blockquote>
<p>存储引擎并无好坏之分，我们应根据业务需求选择合适的存储引擎</p>
</blockquote>
<ul>
<li>InnoDB：如果业务<mark style="background: #BBFABBA6;">对事务的完整性有较高要求</mark>，在<mark style="background: #ADCCFFA6;">高并发场景下要求数据较高的一致性</mark>，<mark style="background: #FFF3A3A6;">数据操作包括增删改查</mark>，那么InnoDB存储引擎是比较合适的选择（现开发使用较多）</li>
<li>MyISAM：如果业务场景以读操作和插入操作为主，只有较少的更新和删除操作，并且对事务的完整性，并发性要求不高。那么MyISAM存储引擎是比较合适的。例如评论功能，购物车数据等对数据安全性要求不高的场景，偶尔丢一两条数据也不要紧的场景。（使用较少，现被nosql服务替代）</li>
<li>MEMORY：数据保存在内存中，访问速度快，通常用于临时表与缓存。但是表的大小有限制，太大太多的数据无法缓存在内存中，且无法保证数据的安全性。（使用较少，现被redis替代）</li>
</ul>
<h2 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h2><h3 id="索引概述"><a href="#索引概述" class="headerlink" title="索引概述"></a>索引概述</h3><p>索引（Index）是帮助mysql<mark style="background: #BBFABBA6;">高效获取数据</mark>的 <mark style="background: #FFF3A3A6;">数据结构（有序）</mark> </p>
<ul>
<li>优点<ol>
<li>提高数据检索效率，降低数据库IO成本（空间换时间）</li>
<li>通过索引列对数据进行排序，降低数据排序成本，降低CPU消耗</li>
</ol>
</li>
<li>缺点<ol>
<li>索引列需要占用存储空间（磁盘空间较便宜，占用大小基本可以忽视）</li>
<li>索引大大提高了查询效率，但同时也降低了更新表的速度，例如UPDATE、INSERT、DELETE的速度降低（一般情况下查询比例比例比增删改比例大得多）</li>
</ol>
</li>
</ul>
<h3 id="索引结构"><a href="#索引结构" class="headerlink" title="索引结构"></a>索引结构</h3><p><strong>mysql的索引是由存储引擎实现的，不同的引擎由不同的索引结构，主要有以下几种</strong></p>
<table>
<thead>
<tr>
<th>索引结构</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>B+Tree索引</td>
<td>最常见的索引类型</td>
</tr>
<tr>
<td>Hash索引</td>
<td>底层数据结构用哈希表实现，只有精确匹配索引的查询才有效，不支持范围查询</td>
</tr>
<tr>
<td>R-Tree索引</td>
<td>空间索引数MyISAM引擎的一个特殊索引，主要用于地理空间数据类型，使用较少</td>
</tr>
<tr>
<td>Full-TEXT索引</td>
<td>通过建立倒排索引快速匹配文档的方式，类似Lucene，Solr，ES,使用较少</td>
</tr>
</tbody></table>
<p><strong>三种常见存储引擎的索引支持情况</strong></p>
<table>
<thead>
<tr>
<th>索引</th>
<th>InnoDB</th>
<th>MyISAM</th>
<th>Memory</th>
</tr>
</thead>
<tbody><tr>
<td>B+Tree索引</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>Hash索引</td>
<td>不支持</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>R-Tree索引</td>
<td>不支持</td>
<td>支持</td>
<td>不支持</td>
</tr>
<tr>
<td>Full-TEXT索引</td>
<td>5.6版本后支持</td>
<td>支持</td>
<td>不支持</td>
</tr>
</tbody></table>
<blockquote>
<p>若没有特别指明，一般索引都是指 <mark style="background: #BBFABBA6;">B+Tree</mark> 结构</p>
</blockquote>
<h4 id="B-Tree"><a href="#B-Tree" class="headerlink" title="B+Tree"></a>B+Tree</h4><blockquote>
<p>BST（二叉查找树）和B-Tree（平衡多路查找树）相关查看 <a class="link"   target="_blank" rel="noopener" href="https://blog.csdn.net/atwdy/article/details/119190011" >二叉树 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> 和 <a class="link"   target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_54787921/article/details/116452743" >B-Tree <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</blockquote>
<p>B+Tree是B-Tree的变种，MySQL普遍使用B+Tree实现索引结构。B+Tree与B-Tree的区别在于B+Tree所有数据都存在叶子节点，叶子节点形成一个单向链表。非叶子节点起到索引数据的作用</p>
<p><strong>经典B+Tree结构如下</strong><br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2023/03/20/B1mtrnyYHTWSZQG.png"
                      alt="image.png"
                ><br>B+树的每个节点（非叶子节点与叶子节点）都会存放在一页中（如下图橙色区块所示，一个磁盘块，一页的大小是固定的为 <code>16k</code>），B+树非叶子节点不存放数据，在有限的空间里能够存放更多的key和指针，在相同数据量情况下，树的层级会更少，层级少，检索速度较快些。而B树因为每个节点都会存放数据，所以单个节点能够存放的key和指针会更少，在相同数据量情况下，B树的层级会更多，层级多，检索速度就会较慢。</p>
<p><strong>mysql中的B+Tree索引</strong><br>mysql对B+Tree进行优化，在B+Tree原来的基础上增加了一个指向相邻叶子节点的链表指针，形成了带有顺序指针的B+Tree，提高区间访问的性能。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2023/03/20/tAVrYp7WgPxu3nw.png"
                      alt="屏幕截图 2023-03-20 153617.png"
                ></p>
<p>从上图可以看到，mysql在B+Tree的每个叶子节点之间增加了一个链表指针形成双向链表，方便范围搜索与排序</p>
<h4 id="Hash索引"><a href="#Hash索引" class="headerlink" title="Hash索引"></a>Hash索引</h4><ul>
<li>哈索索引是采用一定的Hash算法，将键值换算成新的hash值，映射到对应的槽位上，然后存储在hash表中</li>
<li>如果有两个（或以上）键值映射到了同一个槽位上，他们就产生了冲突（也叫hash碰撞），可以通过链表解决，如下图中的 <code>金庸</code> 和 <code>杨逍</code> 两键值都对应到槽位 005 上发生了冲突，此时可以让这两个键值形成一个链表解决此冲突，如果还有其他键值也是005槽位的，只要把这个键值加在链表后方即可</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2023/03/20/raWdfNLt4y5kKzR.png"
                      alt="image.png"
                ></p>
<h5 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h5><ol>
<li>Hash索引只能用于等值比较（精确匹配，如 &#x3D; 和 in），不支持范围查询（例如， between，&gt;，&lt; …）</li>
<li>无法利用索引完成排序（hash运算的结果是无序的）</li>
<li>查询效率最高，通常只需一次检索就行，效率通常高于B+Tree索引（不出现hash碰撞的情况下）</li>
</ol>
<h4 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h4><blockquote>
<p>InnoDB引擎选择B+Tree索引结构的原因</p>
</blockquote>
<ol>
<li>相对于二叉树，层级更少，搜索效率更高</li>
<li>对于B-Tree，无论是叶子节点，还是非叶子节点，都会存放数据。这样导致一页中存储的键值和指针减少，为了保存相同数据，只能增加B-Tree的高度，导致性能降低</li>
<li>相对于Hash索引，Hash索引只支持等值匹配，B+Tree同时还支持范围匹配和排序操作</li>
</ol>
<h3 id="索引分类"><a href="#索引分类" class="headerlink" title="索引分类"></a>索引分类</h3><ul>
<li>主要分为以下四种</li>
</ul>
<table>
<thead>
<tr>
<th>分类</th>
<th>含义</th>
<th>特点</th>
<th>关键字</th>
</tr>
</thead>
<tbody><tr>
<td>主键索引</td>
<td>针对表中主键创建的索引</td>
<td><mark style="background: #FFB86CA6;">默认自动创建，只能有一个</mark></td>
<td>PRIMARY</td>
</tr>
<tr>
<td>唯一索引</td>
<td>避免同一个表中某数据列的值重复</td>
<td>可以有多个</td>
<td>UNIQUE</td>
</tr>
<tr>
<td>常规索引</td>
<td>快速定位特定数据</td>
<td>可以有多个</td>
<td></td>
</tr>
<tr>
<td>全文索引</td>
<td>全文索引查找的是文本中的关键词，而不是比较索引中的值</td>
<td>可以有多个</td>
<td>FULL</td>
</tr>
</tbody></table>
<p>根据索引形式，又可以分为以下两种</p>
<table>
<thead>
<tr>
<th>分类</th>
<th>含义</th>
<th>特点</th>
</tr>
</thead>
<tbody><tr>
<td>聚集索引 (Clustered Index)</td>
<td>将数据存储与索引放到了一块，索引结构的叶子节点保存行的数据</td>
<td>必须有，而且只有一个</td>
</tr>
<tr>
<td>二级索引 (Secondary Index)</td>
<td>将数据与索引分开存储吗，索引结构的叶子节点关联的是对应主键</td>
<td>可以存在多个</td>
</tr>
</tbody></table>
<p><strong>聚集索引的选取规则</strong></p>
<ul>
<li>如果存在主键，主键索引就是聚集索引</li>
<li>如果主键不存在，将使用第一个唯一索引作为聚集索引</li>
<li>如果没有主键，也没有唯一索引，则InnoDB会自动生成一个rowId作为隐藏索引</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2023/03/20/dGUhZD73VXmWTzL.png"
                      alt="_LP8MQ4DFFSXEE_Q__V0ODY.png"
                ></p>
<p>聚集索引，数据与索引放到了一起，如上图在索引结构的叶子节点 索引 <code>id</code> 挂着的数据是对应的行数据，而二级索引的叶子节点则是的存放着对应行的聚集索引值也就 <code>id</code> 的值（以上图中的表为例）</p>
<p><strong>查询过程</strong><br>以下图中表为例，要查询 <code>name=Arm</code> 的行数据，我们给的是一个二级索引 <code>name</code>，数据库会根据二级索引查到对应的 <code>id</code> （主键或者叫聚集索引），然后再根据查到的聚集索引值去查询行数据。这个过程叫回表查询。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2023/03/20/bXtld4hJTY3OCrx.png"
                      alt="KGEECPKG_K_~S33D_ACPQLA.png"
                ></p>
<h4 id="思考-1"><a href="#思考-1" class="headerlink" title="思考"></a>思考</h4><ol>
<li>以下两个语句哪个执行效率高</li>
</ol>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--语句1</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span>; <span class="comment">-- id为主键</span></span><br><span class="line"><span class="comment">--语句2</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;abc&#x27;</span>;</span><br></pre></td></tr></table></figure></div>
<ul>
<li>语句1在查询时通过id去查询B+Tree树，因为id是主键也就是聚集索引。索引可以直接查到行数据，所以效率较高</li>
<li>语句2在查询时通过name去查询，需要先查询name对应的id值，再根据id去查行数据。需要回表查询，所以查询效率较低</li>
</ul>
<h3 id="索引使用"><a href="#索引使用" class="headerlink" title="索引使用"></a>索引使用</h3><ul>
<li>创建索引：<code>CREATE [UNIQUE|FULLTEXT] INDEX index_name ON table_name(表中字段名，可多个)</code></li>
<li>查看索引：<code>SHOW INDEX FROM table_name;</code></li>
<li>删除索引：<code>DROP INDEX index_name ON table_name</code></li>
</ul>
<h3 id="SQL性能分析"><a href="#SQL性能分析" class="headerlink" title="SQL性能分析"></a>SQL性能分析</h3><p>使用命令 <code>show global status like &#39;Com_______&#39;;</code> 查看服务器的操作情况，可以得到结果如下，我们可以根据输出结果查看哪些操作占比比较多，从而去优化相关的操作语句</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Com_binlog    <span class="operator">|</span> <span class="number">0</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Com_commit    <span class="operator">|</span> <span class="number">0</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Com_delete    <span class="operator">|</span> <span class="number">51</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Com_import    <span class="operator">|</span> <span class="number">0</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Com_insert    <span class="operator">|</span> <span class="number">0</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Com_repair    <span class="operator">|</span> <span class="number">0</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Com_revoke    <span class="operator">|</span> <span class="number">0</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Com_select    <span class="operator">|</span> <span class="number">18667</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Com_signal    <span class="operator">|</span> <span class="number">0</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Com_update    <span class="operator">|</span> <span class="number">0</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Com_xa_end    <span class="operator">|</span> <span class="number">0</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br></pre></td></tr></table></figure></div>
<h4 id="慢查询"><a href="#慢查询" class="headerlink" title="慢查询"></a>慢查询</h4><p>上述方法只能知道哪些操作占比较大，但具体是个哪个用户，哪个主机连接，用的哪个数据库，什么时候操作的都不知道。那怎么办？Mysql提供了一种日志记录 <code>慢查询日志</code> ，但默认是关闭的。我们可以通过修改配置文件 <code>my.cnf</code> 添加如下配置开启慢查询日志</p>
<div class="highlight-container" data-rel="Txt"><figure class="iseeu highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line"># 开启慢查询日志</span><br><span class="line">slow_query_log = ON </span><br><span class="line"># 查询超时多久后记录，单位：秒</span><br><span class="line">long_query_time = 1</span><br></pre></td></tr></table></figure></div>
<p>添加完成后重启数据库服务。修改配置文件是永久性操作。如果不想永久开启，可以使用如下命令，效果是一样的，只不过命令开启服务器重启后就没了（此方法需要退出数据库，重新登录才会设置成功）</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- global 也可以换成 session</span></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> slow_query_log<span class="operator">=</span><span class="string">&#x27;ON&#x27;</span>;</span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> long_query_time<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 查看慢查询日志开启状态与日志文件路径</span></span><br><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;slow_query%&#x27;</span>;</span><br></pre></td></tr></table></figure></div>

<h4 id="Profile"><a href="#Profile" class="headerlink" title="Profile"></a>Profile</h4><p>慢查询日志记录了执行时间超过指定时长的SQL语句，通过记录的信息，我们可以知道SQL的执行用户，此次操作的数据库等等。但有时候，有些SQL执行时长没有超时，但离超时就差几毫秒，此类SQL不会被慢查询记录，而且通过慢查询我们无法得知SQL执行过程的每一步耗时。若想查看这些SQL的详细执行时间我们可以使用Mysql的 <code>Profile</code><br>首先查看数据库是否支持 <code>profile</code>，使用命令 <code>select @@have_profiling</code> 得到如下结果</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> @<span class="variable">@have</span>_profiling;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line"><span class="operator">|</span> @<span class="variable">@have</span>_profiling <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line"><span class="operator">|</span> YES              <span class="operator">|</span> <span class="comment">-- YES 支持profile</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br></pre></td></tr></table></figure></div>
<p>profile默认是关闭的，可以使用 <code>set profiling =1;</code> 开启profile，然后随便执行几个sql操作后受用命令 <code>show profiles;</code>  查看SQL操作的开销</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> profiles ;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+------------+-------------------------+</span></span><br><span class="line"><span class="operator">|</span> Query_ID <span class="operator">|</span> Duration   <span class="operator">|</span> Query                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+------------+-------------------------+</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">1</span> <span class="operator">|</span> <span class="number">0.00056875</span> <span class="operator">|</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">2</span> <span class="operator">|</span> <span class="number">0.00014950</span> <span class="operator">|</span> <span class="keyword">set</span> profiling <span class="operator">=</span><span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">3</span> <span class="operator">|</span> <span class="number">0.00053650</span> <span class="operator">|</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">4</span> <span class="operator">|</span> <span class="number">0.00055050</span> <span class="operator">|</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">5</span> <span class="operator">|</span> <span class="number">0.00049625</span> <span class="operator">|</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">6</span> <span class="operator">|</span> <span class="number">0.00052800</span> <span class="operator">|</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+------------+-------------------------+</span></span><br></pre></td></tr></table></figure></div>
<p>若想知道指定SQL执行前后的耗时，我们可以使用命令 <code>show profile for query Query_ID;</code> 来查看，结果大致如下</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> profile <span class="keyword">for</span> query <span class="number">6</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> Status                         <span class="operator">|</span> Duration <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> starting                       <span class="operator">|</span> <span class="number">0.000045</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Executing hook <span class="keyword">on</span> transaction  <span class="operator">|</span> <span class="number">0.000002</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> starting                       <span class="operator">|</span> <span class="number">0.000005</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> checking permissions           <span class="operator">|</span> <span class="number">0.000003</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Opening tables                 <span class="operator">|</span> <span class="number">0.000029</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> init                           <span class="operator">|</span> <span class="number">0.000003</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">System</span> lock                    <span class="operator">|</span> <span class="number">0.000004</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> optimizing                     <span class="operator">|</span> <span class="number">0.000003</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> statistics                     <span class="operator">|</span> <span class="number">0.000006</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> preparing                      <span class="operator">|</span> <span class="number">0.000010</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> executing                      <span class="operator">|</span> <span class="number">0.000044</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">end</span>                            <span class="operator">|</span> <span class="number">0.000001</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> query <span class="keyword">end</span>                      <span class="operator">|</span> <span class="number">0.000002</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> waiting <span class="keyword">for</span> handler <span class="keyword">commit</span>     <span class="operator">|</span> <span class="number">0.000005</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> closing tables                 <span class="operator">|</span> <span class="number">0.000004</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> freeing items                  <span class="operator">|</span> <span class="number">0.000022</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> logging slow query             <span class="operator">|</span> <span class="number">0.000325</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> cleaning up                    <span class="operator">|</span> <span class="number">0.000015</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------+----------+</span></span><br></pre></td></tr></table></figure></div>
<p>如果想知道SQL执行过程中CPU使用情况只需在 <code>show profile for query Query_ID;</code> 中加个 <code>cpu</code> 的参数即可变成 <code>show profile cpu for query Query_ID;</code></p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">+</span><span class="comment">--------------------------------+----------+----------+------------+</span></span><br><span class="line"><span class="operator">|</span> Status                         <span class="operator">|</span> Duration <span class="operator">|</span> CPU_user <span class="operator">|</span> CPU_system <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------+----------+----------+------------+</span></span><br><span class="line"><span class="operator">|</span> starting                       <span class="operator">|</span> <span class="number">0.000045</span> <span class="operator">|</span> <span class="number">0.000044</span> <span class="operator">|</span>   <span class="number">0.000000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Executing hook <span class="keyword">on</span> transaction  <span class="operator">|</span> <span class="number">0.000002</span> <span class="operator">|</span> <span class="number">0.000002</span> <span class="operator">|</span>   <span class="number">0.000000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> starting                       <span class="operator">|</span> <span class="number">0.000005</span> <span class="operator">|</span> <span class="number">0.000005</span> <span class="operator">|</span>   <span class="number">0.000000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> checking permissions           <span class="operator">|</span> <span class="number">0.000003</span> <span class="operator">|</span> <span class="number">0.000003</span> <span class="operator">|</span>   <span class="number">0.000000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Opening tables                 <span class="operator">|</span> <span class="number">0.000029</span> <span class="operator">|</span> <span class="number">0.000029</span> <span class="operator">|</span>   <span class="number">0.000000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> init                           <span class="operator">|</span> <span class="number">0.000003</span> <span class="operator">|</span> <span class="number">0.000003</span> <span class="operator">|</span>   <span class="number">0.000000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">System</span> lock                    <span class="operator">|</span> <span class="number">0.000004</span> <span class="operator">|</span> <span class="number">0.000004</span> <span class="operator">|</span>   <span class="number">0.000000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> optimizing                     <span class="operator">|</span> <span class="number">0.000003</span> <span class="operator">|</span> <span class="number">0.000003</span> <span class="operator">|</span>   <span class="number">0.000000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> statistics                     <span class="operator">|</span> <span class="number">0.000006</span> <span class="operator">|</span> <span class="number">0.000007</span> <span class="operator">|</span>   <span class="number">0.000000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> preparing                      <span class="operator">|</span> <span class="number">0.000010</span> <span class="operator">|</span> <span class="number">0.000009</span> <span class="operator">|</span>   <span class="number">0.000000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> executing                      <span class="operator">|</span> <span class="number">0.000044</span> <span class="operator">|</span> <span class="number">0.000045</span> <span class="operator">|</span>   <span class="number">0.000000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">end</span>                            <span class="operator">|</span> <span class="number">0.000001</span> <span class="operator">|</span> <span class="number">0.000001</span> <span class="operator">|</span>   <span class="number">0.000000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> query <span class="keyword">end</span>                      <span class="operator">|</span> <span class="number">0.000002</span> <span class="operator">|</span> <span class="number">0.000002</span> <span class="operator">|</span>   <span class="number">0.000000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> waiting <span class="keyword">for</span> handler <span class="keyword">commit</span>     <span class="operator">|</span> <span class="number">0.000005</span> <span class="operator">|</span> <span class="number">0.000004</span> <span class="operator">|</span>   <span class="number">0.000000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> closing tables                 <span class="operator">|</span> <span class="number">0.000004</span> <span class="operator">|</span> <span class="number">0.000004</span> <span class="operator">|</span>   <span class="number">0.000000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> freeing items                  <span class="operator">|</span> <span class="number">0.000022</span> <span class="operator">|</span> <span class="number">0.000022</span> <span class="operator">|</span>   <span class="number">0.000000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> logging slow query             <span class="operator">|</span> <span class="number">0.000325</span> <span class="operator">|</span> <span class="number">0.000058</span> <span class="operator">|</span>   <span class="number">0.000000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> cleaning up                    <span class="operator">|</span> <span class="number">0.000015</span> <span class="operator">|</span> <span class="number">0.000015</span> <span class="operator">|</span>   <span class="number">0.000000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------+----------+----------+------------+</span></span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>上述三种方式可以查看SQL的执行频率与执行时间，根据频率与执行时间，我们可以大概推断SQL的性能。但这种方式只是粗略地判定，并不能真正判定一条SQL的性能。要想真正SQL的执行性能，我们需要使用 <code>Explain</code></p>
</blockquote>
<h4 id="Explain执行计划"><a href="#Explain执行计划" class="headerlink" title="Explain执行计划"></a>Explain执行计划</h4><p><strong>使用</strong>：只需在SQL语句最前面添加 <code>explain</code> 或 <code>desc</code> 即可，例如下面这个例子</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> name <span class="keyword">from</span> course <span class="keyword">where</span> id <span class="keyword">in</span> (<span class="keyword">select</span> uc.courseId <span class="keyword">from</span> user_course uc <span class="keyword">where</span> userId <span class="keyword">in</span> (<span class="keyword">select</span> id <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> class_id <span class="operator">=</span> (<span class="keyword">select</span> id <span class="keyword">from</span> class <span class="keyword">where</span> className<span class="operator">=</span><span class="string">&#x27;class1&#x27;</span>)));</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+--------+------------+--------+---------------------+-------------+---------+------------------+------+----------+--------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span>  <span class="operator">|</span> partitions <span class="operator">|</span> type   <span class="operator">|</span> possible_keys       <span class="operator">|</span> key         <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>              <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> filtered <span class="operator">|</span> Extra                                      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+--------+------------+--------+---------------------+-------------+---------+------------------+------+----------+--------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> <span class="keyword">PRIMARY</span>     <span class="operator">|</span> <span class="keyword">user</span>   <span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span> <span class="keyword">ref</span>    <span class="operator">|</span> <span class="keyword">PRIMARY</span>,fk_class_id <span class="operator">|</span> fk_class_id <span class="operator">|</span> <span class="number">5</span>       <span class="operator">|</span> const            <span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span>   <span class="number">100.00</span> <span class="operator">|</span> <span class="keyword">Using</span> <span class="keyword">where</span>; <span class="keyword">Using</span> index; <span class="keyword">Start</span> temporary  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> <span class="keyword">PRIMARY</span>     <span class="operator">|</span> uc     <span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span> <span class="keyword">ALL</span>    <span class="operator">|</span> <span class="keyword">NULL</span>                <span class="operator">|</span> <span class="keyword">NULL</span>        <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> <span class="keyword">NULL</span>             <span class="operator">|</span>    <span class="number">7</span> <span class="operator">|</span>    <span class="number">14.29</span> <span class="operator">|</span> <span class="keyword">Using</span> <span class="keyword">where</span>; <span class="keyword">Using</span> <span class="keyword">join</span> buffer (hash <span class="keyword">join</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> <span class="keyword">PRIMARY</span>     <span class="operator">|</span> course <span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span> eq_ref <span class="operator">|</span> <span class="keyword">PRIMARY</span>             <span class="operator">|</span> <span class="keyword">PRIMARY</span>     <span class="operator">|</span> <span class="number">4</span>       <span class="operator">|</span> test.uc.courseId <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span>   <span class="number">100.00</span> <span class="operator">|</span> <span class="keyword">End</span> temporary                              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">4</span> <span class="operator">|</span> SUBQUERY    <span class="operator">|</span> class  <span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span> const  <span class="operator">|</span> className           <span class="operator">|</span> className   <span class="operator">|</span> <span class="number">50</span>      <span class="operator">|</span> const            <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span>   <span class="number">100.00</span> <span class="operator">|</span> <span class="keyword">Using</span> index                                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+--------+------------+--------+---------------------+-------------+---------+------------------+------+----------+--------------------------------------------+</span></span><br></pre></td></tr></table></figure></div>

<p><strong>返回结果每列的解析</strong></p>
<ul>
<li>id：select查询语句的序列号，表示查询中执行select子句或者操作表的顺序。若id一样，则表的执行顺序是从上往下，若id不一样则id越大越先执行</li>
<li>select_type：查询的类型<ul>
<li>SIMPLE：简单表，不做表连接或子查询</li>
<li>PRIMARY：主查询，即外层的查询</li>
<li>UNION：union中的第二个或者后面的查询语句</li>
<li>SUBQUERY：select和where之后包含的子查询</li>
</ul>
</li>
<li><mark style="background: #BBFABBA6;">type：连接类型，性能由好到差分别为NULL，SYSTEM，CONST，EQ_REF，REF，INDEX，ALL</mark></li>
<li><mark style="background: #FFF3A3A6;">possible_keys：SQL操做的表可能用到的索引</mark></li>
<li><mark style="background: #FFB86CA6;">key：实际用到的索引</mark></li>
<li><mark style="background: #FFB8EBA6;">key_len：使用到的索引字节数，为索引字段最大可能值，非实际长度</mark></li>
<li>ref：非唯一索引查询</li>
<li>rows：执行查询的行数，预估值</li>
<li>filtered：查询返回行数占读取行数的百分比，值越大越好</li>
<li><mark style="background: #ABF7F7A6;">extr：额外显示的信息</mark><br>高亮的部分表示需要重点关注的内容</li>
</ul>
<h3 id="索引使用-1"><a href="#索引使用-1" class="headerlink" title="索引使用"></a>索引使用</h3><h4 id="索引使用检验"><a href="#索引使用检验" class="headerlink" title="索引使用检验"></a>索引使用检验</h4><p>假设有一张存放千万数据的表，在没有建立索引的情况下（除主键外，mysql默认会为主键建立索引）我们<mark style="background: #ADCCFFA6;">根据非主键字段查询数据</mark>，耗时会很久，例如下面这样</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_sku <span class="keyword">where</span> sn<span class="operator">=</span><span class="string">&#x27;100000003145001&#x27;</span>\G; <span class="comment">-- \G表示查询结果以列形式展示</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">data......</span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">37.02</span> sec) <span class="comment">-- 查询用时 37秒</span></span><br></pre></td></tr></table></figure></div>
<p>我们可以看到从没建立索引的千万数据的表查询数据要花费2分钟多，这不是我们想要的结果，解决方式也很简单。只需给对应字段建立索引即可，如下所示，建立索引的时间与表中数据量挂钩</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> index ids_sku_sn <span class="keyword">on</span> tb_sku(sn);</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">1</span> min <span class="number">5.47</span> sec) <span class="comment">-- 1000w数据建立索引花费了 1分5秒</span></span><br><span class="line">Records: <span class="number">0</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br></pre></td></tr></table></figure></div>
<p>索引建立完成后我们使用相同的查询语句再次查询</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_sku <span class="keyword">where</span> sn<span class="operator">=</span><span class="string">&#x27;100000003145001&#x27;</span>\G; <span class="comment">-- \G表示查询结果以列形式展示</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">data......</span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec) <span class="comment">-- 查询用时 小于1秒，这个速度与使用主键查询差不多快</span></span><br></pre></td></tr></table></figure></div>

<h4 id="使用规则"><a href="#使用规则" class="headerlink" title="使用规则"></a>使用规则</h4><h5 id="最左前缀法则-联合索引"><a href="#最左前缀法则-联合索引" class="headerlink" title="最左前缀法则(联合索引)"></a>最左前缀法则(联合索引)</h5><ul>
<li>主要针对于联合索引（一个索引关联了多个字段）使用联合需要遵守最左前缀法则。最左前缀法则指查询从索引的最左列开始，且不跳过索引中的列。如果跳过了某列，索引将部分失效（跳过后的字段索引失效）如以下例子，假设有一张表有索引 <code>idx_user_age_gender_status</code> 关联了字段 <code>age</code> <code>gender</code> <code>status</code></li>
<li>使用 <code>explain</code> 查看查询使用了那些索引<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> age<span class="operator">=</span><span class="number">24</span> <span class="keyword">and</span> status<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> gender<span class="operator">=</span><span class="string">&#x27;man&#x27;</span>\G;</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: <span class="keyword">user</span></span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: idx_user_age_gender_status <span class="comment">-- 使用了联合索引</span></span><br><span class="line">          key: idx_user_age_gender_status</span><br><span class="line">      key_len: <span class="number">5</span></span><br><span class="line">          <span class="keyword">ref</span>: const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">6</span></span><br><span class="line">     filtered: <span class="number">16.67</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index <span class="keyword">condition</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">2</span> warnings (<span class="number">0.00</span> sec)</span><br><span class="line"><span class="comment">---------------------------------------------------------------------------------</span></span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> age<span class="operator">=</span><span class="number">24</span> <span class="keyword">and</span> status<span class="operator">=</span><span class="number">1</span>\G;</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: <span class="keyword">user</span></span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: idx_user_age_gender_status <span class="comment">-- 虽然只使用了两个字段条件，但查询还是使用了索引（符合最左原则，从最左边的age开始）</span></span><br><span class="line">          key: idx_user_age_gender_status</span><br><span class="line">      key_len: <span class="number">5</span></span><br><span class="line">          <span class="keyword">ref</span>: const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">6</span></span><br><span class="line">     filtered: <span class="number">16.67</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index <span class="keyword">condition</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">2</span> warnings (<span class="number">0.00</span> sec)</span><br><span class="line"><span class="comment">----------------------------------------------------------------------------------</span></span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> status<span class="operator">=</span><span class="number">1</span>\G; <span class="comment">-- 此次查询跳过了age，联合索引idx_user_age_gender_status，最左边的字段age没出现，故索引失效</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: <span class="keyword">user</span></span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span>    <span class="comment">-- 全表查询</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span>   <span class="comment">-- 没有使用索引</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">6</span></span><br><span class="line">     filtered: <span class="number">16.67</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">2</span> warnings (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></div></li>
</ul>
<blockquote>
<p>关联字段必须存在，无顺序要求。</p>
</blockquote>
<h5 id="范围查询"><a href="#范围查询" class="headerlink" title="范围查询"></a>范围查询</h5><ul>
<li>在联合索引中，出现范围查询（&gt;，&lt; ）范围查询右侧的索引失效</li>
<li>在开发中，若业务允许应尽量使用 (&gt;&#x3D; 和 &lt;&#x3D;)<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--                                  age使用范围查询，所以age右侧的gender的索引失效</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;jack&#x27;</span> <span class="keyword">and</span> age <span class="operator">&gt;</span> <span class="number">23</span> <span class="keyword">and</span> gender<span class="operator">=</span><span class="string">&#x27;男&#x27;</span>;</span><br></pre></td></tr></table></figure></div></li>
</ul>
<h5 id="索引列运算"><a href="#索引列运算" class="headerlink" title="索引列运算"></a>索引列运算</h5><ul>
<li>不要在索引列上进行运算操作，否则索引将失效<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--                                  对索引age进行函数运算，索引失效</span></span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> <span class="built_in">substring</span>(age, <span class="number">2</span>)<span class="operator">=</span><span class="number">4</span>\G;</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: <span class="keyword">user</span></span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span>  </span><br><span class="line">          key: <span class="keyword">NULL</span>  <span class="comment">-- 没有使用索引</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">6</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br></pre></td></tr></table></figure></div></li>
</ul>
<h5 id="字符串不加单引号"><a href="#字符串不加单引号" class="headerlink" title="字符串不加单引号"></a>字符串不加单引号</h5><p>如果字符串类型的字段在查询时没有添加单引号，索引将会失效，例如</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 在该表中 phone字段是 char类型，查询时应该加上单引号，否则索引将失效</span></span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> phone<span class="operator">=</span><span class="number">13456789001</span>\G;</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: <span class="keyword">user</span></span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: idx_phone <span class="comment">-- 可能用到的索引</span></span><br><span class="line">          key: <span class="keyword">NULL</span>      <span class="comment">-- 实际没有用到，因为发生了隐式类型转换</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">6</span></span><br><span class="line">     filtered: <span class="number">16.67</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br></pre></td></tr></table></figure></div>
<h5 id="模糊查询"><a href="#模糊查询" class="headerlink" title="模糊查询"></a>模糊查询</h5><p>在使用模糊查询时，如果 <code>%</code> 添加在尾部，那么索引不会失效，但如果是添加在头部，索引将会失效</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 通配符添加在最前面，索引失效</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> phone <span class="keyword">like</span> <span class="string">&#x27;%56789001&#x27;</span>;</span><br><span class="line"><span class="comment">-- 通配符添加在尾部，索引不会失效</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> phone <span class="keyword">like</span> <span class="string">&#x27;134%&#x27;</span>;</span><br></pre></td></tr></table></figure></div>

<h5 id="or连接"><a href="#or连接" class="headerlink" title="or连接"></a>or连接</h5><p>用 <code>or</code> 分隔开的条件，如果 <code>or</code> 前的条件中的字段有索引，而后面的字段没有索引，那么涉及的索引都不会被用到，只有 <code>or</code> 两侧的字段都有索引时，索引才会生效 </p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 本表中 phone有建立索引，name则没有建立索引，此次查询将不会用到索引</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> phone<span class="operator">=</span><span class="string">&#x27;13456789001&#x27;</span> <span class="keyword">or</span> name<span class="operator">=</span><span class="string">&#x27;jack&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- id 跟 phone 都有索引，此次查询使用了索引</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> phone<span class="operator">=</span><span class="string">&#x27;13456789001&#x27;</span> <span class="keyword">or</span> id<span class="operator">=</span><span class="number">1</span>;</span><br></pre></td></tr></table></figure></div>

<h5 id="数据分布影响"><a href="#数据分布影响" class="headerlink" title="数据分布影响"></a>数据分布影响</h5><p>如果mysql评估使用索引比全表扫描慢，那么将不使用索引。当表中数据绝大部分满足查询条件时，mysql便会放弃索引使用全表扫描。<br>例如，一张用户表中有70%的用户数据的年龄大于20，这时，如果我们查找年龄大于20的数据时，mysql会放弃索引（年龄字段建立了索引），使用全表扫描，因为mysql评估得到查询的结果占全表的绝大部分。而如果是查询年龄小于20的才会使用索引。</p>
<blockquote>
<p>是否用索引是根据表中数据分布情况来决定的，<mark style="background: #FF5582A6;">当查询的数据占表数据的绝大部分就会放弃使用索引，反之使用索引</mark></p>
</blockquote>
<h5 id="SQL提示"><a href="#SQL提示" class="headerlink" title="SQL提示"></a>SQL提示</h5><p>在SQL语句中加入一些提示来达成优化操作的目的。</p>
<ol>
<li>use index：建议使用指定索引，实际使用哪个由mysql评估，不一定使用</li>
<li>ignore index：忽略指定索引</li>
<li>force index：强制使用指定索引</li>
</ol>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查询表 table_name 时 建议使用索引 index_name</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> table_name use index(index_name);</span><br><span class="line"><span class="comment">-- 查询表时忽略指定索引</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> table_name ignore index(index_name);</span><br><span class="line"><span class="comment">-- 查询表时强制使用指定索引</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> table_name force index(index_name);</span><br></pre></td></tr></table></figure></div>

<h5 id="覆盖索引"><a href="#覆盖索引" class="headerlink" title="覆盖索引"></a>覆盖索引</h5><p>查询过程中使用了索引，且此次查询需要返回的数据所对应的字段在该索引中已经全部找到</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 本表username与password建立了联合索引 idx_username_password</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 本条SQL查询到的结果在索引中已全部找到，不需要回表查询</span></span><br><span class="line"><span class="keyword">select</span> id,username,password <span class="keyword">from</span> account <span class="keyword">where</span> username<span class="operator">=</span><span class="string">&#x27;kita&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 本条SQL查询到的结果只有 id, username, password在索引中找到</span></span><br><span class="line"><span class="keyword">select</span> id,username,password,age,address <span class="keyword">from</span> account <span class="keyword">where</span> username<span class="operator">=</span><span class="string">&#x27;kita&#x27;</span>; <span class="comment">-- 不适用覆盖索引，因为联合索引idx_username_password不全覆盖select选择的的字段 age和address。这两个的值还是需要根据叶子节点挂的id进行回表查询</span></span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>当二级索引中的数据包含了查询所需要的数据时将直接返回，就不在聚集索引（主键）再找一遍了。<br>需要注意的是：当索引不全覆盖select选择的字段以及where条件中对索引进行like等操作时，此次查询不使用覆盖索引。</p>
</blockquote>
<h5 id="前缀索引"><a href="#前缀索引" class="headerlink" title="前缀索引"></a>前缀索引</h5><p>当字段类型为字符串（varchar，text等）时，有时候字符串很长，建立索引会让索引变得很大。查询时浪费磁盘IO，影响效率，此时我们可以把字符串的一部分前缀抽出出来建立索引从而节省索引空间，提高查询效率。<br>使用： <code>CREATE INDEX index_name ON table_name(COLUMN(截取长度))</code> 建立前缀索引<br>前缀长度根据索引的选择性来决定。选择性指不重复的索引值与表中数据的比（不重复的值 &#x2F; 总数据）索引值越高查询效率越高，若字段有唯一约束则选择性为1，是最好的索引选择性，性能最好。索引的选择性可以使用公式计算</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 可以多次尝试此公式查看结果选择一个结果最接近1，且截取长度较低的值</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="keyword">distinct</span> <span class="built_in">substring</span>(<span class="number">1</span>, 截取长度)) <span class="operator">/</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> table_name;</span><br></pre></td></tr></table></figure></div>
<p><strong>前缀索引查询流程</strong><br>假设下列语句中 <code>comment</code> 关联了前缀索引</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> table_name <span class="keyword">where</span> comment<span class="operator">=</span><span class="string">&#x27;传入的字符串内容&#x27;</span></span><br></pre></td></tr></table></figure></div>
<p>上述SQL先查询二级索引取聚集索引值，再去聚集索引取<code>行数据A</code>，然后从<code>行数据A</code>拿出 <code>comment</code> 字段值与传递进来的 <code>传入的字符串内容</code> 匹配。然后通过叶子节点链表查下一<code>行数据B</code>再匹配 <code>comment</code> 如果匹配不成功则返回<code>行数据A</code>如果行数据B也匹配成功则再拿下一行的数据再匹配，直到下一行数据匹配失败，再组装所有行数据并返回</p>
<h5 id="单列索引与联合索引的选择"><a href="#单列索引与联合索引的选择" class="headerlink" title="单列索引与联合索引的选择"></a>单列索引与联合索引的选择</h5><ul>
<li>单列索引：一个索引只关联了一个字段（列）</li>
<li>联合索引：一个索引关联了多个字段（列）</li>
</ul>
<p>单列索引和联合索引的选择应根据业务场景决定。例如：有张表学生表记录学生信息有字段<code>name</code> <code>age</code>。在一般情况下，<code>name</code> 的数据重复度会较低，而 <code>age</code> 的重复度会较高。现有查询语句 <code>select * from students where name=&#39;jack&#39; and age=18;</code> 则</p>
<ul>
<li>name和age单独建立索引：一般来说，mysql会选择其中一个，name的可能性会较大。因为mysql会统计每个索引上的重复度，优先选用低重复读的字段。而且为了维护索引的开销，此时 age 字段的索引可以不用创建</li>
<li>name和age创建了联合索引：切合度最好，mysql会直接选用这个索引，但索引维护成本较大一些。索引占用的存储空间也会大些</li>
</ul>
<p>在业务场景中，如果存在多个查询条件，建议使用联合索引</p>
<h3 id="索引创建的原则"><a href="#索引创建的原则" class="headerlink" title="索引创建的原则"></a>索引创建的原则</h3><ol>
<li>针对与数据量较大，且查询频率比较频繁的表建立索引</li>
<li>针对常作为 查询条件(where) 、分组(group by)、排序(order by) 操作的字段建立索引</li>
<li>尽量选择区分度高的字段建立索引，尽量建立唯一索引，区分度越高，索引效率越高</li>
<li>如果是字符串类型的字段，建议使用前缀索引</li>
<li>尽量使用联合索引，减少单列索引，查询时，联合索引很多时候可以覆盖索引，节省存储空间，提高查询效率，避免回表。</li>
<li>要控制索引数量，索引不是越多越好，索引越多，维护索引结构的代价也越大，会影响增删改的效率</li>
<li>如果索引字段不能存储null值，应该在建表时对该字段使用 not null 约束。当优化器知道每个字段是否包含null值时。可以更好确定使用哪个索引效率更高。</li>
</ol>
<h2 id="SQL优化"><a href="#SQL优化" class="headerlink" title="SQL优化"></a>SQL优化</h2><h3 id="插入数据优化"><a href="#插入数据优化" class="headerlink" title="插入数据优化"></a>插入数据优化</h3><ul>
<li><p>批量插入：通常的数据插入方法是 <code>INSERT INTO table_name (字段名...) values (对应的值...)</code>。这是单次插入数据。每一次的插入操作都需要建立网络连接，数据库IO操作，SQL语句的解析。很明显这样效率与性能是很低的。面对大量的数据，应该使用批量插入 <code>INSERT INTO table_name (字段名...) values (对应的值1),(对应的值2)...</code> 当然批量插入的数据量也不应该太大，可以将其分割开分次插入。每次插入500到1000条数据。每次不建议超过1000条。</p>
</li>
<li><p>手动事务提交：建议手动提交事务。mysql默认是自动提交事务的，这样做会在数据插入时频繁地开启事务，建议在执行完插入语句全部完成后再统一提交事务</p>
</li>
<li><p>主键顺序插入：在执行插入语句时，<mark style="background: #FFB86CA6;">主键顺序插入性能高于乱序插入</mark>。建议按主键的顺序插入数据。</p>
</li>
<li><p>大批量的数据插入：如果一次性需要插入大量的数据，使用 <code>INSERT</code> 插入性能较低。此时可以使用 <code>LOAD</code> 指令进行插入</p>
</li>
</ul>
<p>假设有本地数据文件，其内容如下</p>
<div class="highlight-container" data-rel="Txt"><figure class="iseeu highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1,jack1,24,班级名称</span><br><span class="line">2,jack2,24,班级名称</span><br><span class="line">3,jack3,24,班级名称</span><br><span class="line">4,jack4,24,班级名称</span><br><span class="line">....</span><br></pre></td></tr></table></figure></div>
<p>有张表，其结构如下</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name <span class="operator">|</span> age <span class="operator">|</span> classname <span class="operator">|</span></span><br></pre></td></tr></table></figure></div>
<p>mysql加载此文件导入文件内容到数据库</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 在客户端连接mysql时加上参数 --local--infine</span></span><br><span class="line"><span class="comment">-- 开启从本地加载文件导入数据</span></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> local_infine<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 加载文件数据到mysql</span></span><br><span class="line">load data <span class="keyword">local</span> infile <span class="string">&#x27;要加载的本地数据文件路径&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> `tb_sku` fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span> lines terminated <span class="keyword">by</span> <span class="string">&#x27;\n&#x27;</span>;</span><br></pre></td></tr></table></figure></div>
<ul>
<li><code>fields terminated by &#39;,&#39;</code> ：表示加载的每行数据，其字段使用 <code>,</code> 分隔</li>
<li><code>lines terminated by &#39;\n&#39;;</code>：表示每行数据使用 <code>\n</code> 分割，也就是换行分隔</li>
</ul>
<h3 id="主键优化"><a href="#主键优化" class="headerlink" title="主键优化"></a>主键优化</h3><p>在InnoDB存储引擎中，表数据都是根据<mark style="background: #ADCCFFA6;">主键顺序</mark>组织存放的，这种存储方式的表成为存储组织表(Index organized table IOT)， <a href="/mysql-note/mysql%E7%AC%94%E8%AE%B02/../#%E9%80%BB%E8%BE%91%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84">查看InnoDB的逻辑存储结构</a></p>
<h4 id="页分裂"><a href="#页分裂" class="headerlink" title="页分裂"></a>页分裂</h4><ul>
<li><p>按主键顺序插入数据时，页的情况如下图<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2023/03/22/kQvb3GMrU16wtSy.png"
                      alt="顺序插入流程.png"
                ></p>
</li>
<li><p>当非顺序插入时，因叶子节点是有序的。所以会开辟一个新的页<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2023/03/22/DNg3t7ICrcEke8K.png"
                     
                ><br>开辟新空间后，会将原本要入的页的50%取出，再跟传值一起插入新页中<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2023/03/22/cL25e4OaKhtSDz9.png"
                     
                ><br>这种现象称为页分裂，会比较消耗性能</p>
</li>
</ul>
<h4 id="页合并"><a href="#页合并" class="headerlink" title="页合并"></a>页合并</h4><p>当删除一行数据记录时，实际上并没有被物理删除，只是被标记(flaged) 为删除，同时允许其他记录使用该空间。当页中的标记删除记录超过 <code>MERGE_THRESHOLD</code> (默认为页的50%)时，InnoDB就会开始寻找相邻的两个页。查看是否满足合并的条件。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2023/03/22/djlzIMOEHypLv7g.png"
                      alt="="
                ><br>当满足合并的条件时，InnoDB就会合并符合条件的表，如上图，会将3号页的数据移动到2号页</p>
<h4 id="主键的设计原则"><a href="#主键的设计原则" class="headerlink" title="主键的设计原则"></a>主键的设计原则</h4><ul>
<li>在满足业务需求的情况下，我们尽量降低主键的长度。因为虽然主键只有且只能有一个，其叶子节点挂着的是行数据，但二级索引有多个，而二级索引叶子节点挂着的是主键数据。</li>
<li>插入数据时，尽量使用顺序插入，选择使用 <code>AUTO_INCREMENT</code> 自增主键。</li>
<li>尽量不要使用UUID或自然字段做主键。此类字段值多为无序且长度长，如身份证号</li>
<li>在业务操作时，尽量避免对主键进行修改（修改逐渐需要更改索引结构，代价大）</li>
</ul>
<h3 id="order-by-优化"><a href="#order-by-优化" class="headerlink" title="order by 优化"></a>order by 优化</h3><ol>
<li>using filesort：通过表的索引，或全表扫描读取满足条件的数据行，然后在排行缓冲区SortBuffer中完成排序操作。所有不是通过索引直接返回的排序结果都叫 FileSort 排序</li>
<li>using index：通过有序索引顺序扫描直接返回有序数据，不需要额外的排序操作，效率较高。</li>
</ol>
<p>在使用order by排序时应尽量优化成 <code>using index</code>，优化方式为<mark style="background: #BBFABBA6;">给对应字段添加索引</mark>即可</p>
<p><strong>注意事项</strong></p>
<ul>
<li>若使用了联合索引，需保证所用索引排序方式都为 <code>asc</code> 升序（默认），否则在排序时非升序索引会再排序一次。如果想一个升序一个降序，可以再创建一个联合索引 <code>create index idx_f1_f2_ad on table_name(f1 asc, f2 desc);</code> 在创建索引时指定索引的排序方式。</li>
<li>排序若多字段使用了联合索引，也应该遵循 <code>左前缀法则</code></li>
<li>尽量使用覆盖索引，避免 <code>select *</code></li>
<li>如果不可避免地出现了 <code>using filesort</code> 即此次排序还是要到排序缓冲区中操作。那我们可以适当增加缓冲区 <code>sort_buffer_size</code> (默认256k)的大小</li>
</ul>
<h3 id="group-by-优化"><a href="#group-by-优化" class="headerlink" title="group by 优化"></a>group by 优化</h3><ul>
<li>分组操作时，索引的使用也需要遵循最左前缀法则</li>
<li>若没有使用索引进行分组，会使用到临时表。</li>
</ul>
<h3 id="limit优化"><a href="#limit优化" class="headerlink" title="limit优化"></a>limit优化</h3><p>在分页查询数据时，如果数据量特别大，有千万级别，那么使用<br><code>select * from tb_name limit 9000000,10;</code> 耗时会很长，且使用此方法需要mysql排序前9000010条的记录，但只是返回 9000000 - 9000010的记录，其他记录丢弃，代价是非常大的。<br>所以我们一般在分页查询时，可以创建覆盖索引提高性能。同时使用覆盖索引加子查询的形式进行优化。如下</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> sku.<span class="operator">*</span> <span class="keyword">from</span> tb_sku sku, (<span class="keyword">select</span> id <span class="keyword">from</span> tb_sku <span class="keyword">order</span> <span class="keyword">by</span> id limit <span class="number">9000000</span>,<span class="number">10</span>) a <span class="keyword">where</span> sku.id<span class="operator">=</span>a.id;</span><br></pre></td></tr></table></figure></div>
<p>在本例中，先查询9000000后10条数据的主键id（括号里的，查询结果作为临时表进行多表联查），然后再根据这些id去查详细数据。在建立索引的情况下，耗时只用了4秒（本人的开发环境下），而使用 传统的 <code>select * from tb_name limit 9000000,10;</code> 方法则用了快一分钟。所以在实际开发中，若数据量特大，应尽量使用覆盖索引加子查询的方式进行分页查询。</p>
<h3 id="count优化"><a href="#count优化" class="headerlink" title="count优化"></a>count优化</h3><ul>
<li>MyISAM引擎会把表的总行数记录在磁盘上，执行<code>count(*)</code>时直接放回这个数。前提是查询时没有where条件。</li>
<li>InnoDB引擎在进行 <code>count(*)</code> 操作时，会把数据一行一行读出来然后进行累计计数，在特大数据量的情况下很明显是非常耗时不高效的。对于 <code>count</code> 的优化。<blockquote>
<p>优化方式：自己计数，自己维护一个值，增删时更改这个值。</p>
</blockquote>
</li>
</ul>
<p>COUNT的几种用法</p>
<ul>
<li>COUNT(主键)：InnoDB引擎会遍历整张表，把每一行的主键id值取出来，然后服务层进行累加</li>
<li>COUNT(字段)：<ul>
<li>not null：InnoDB会遍历表去每一行的字段值，服务层再进行累加</li>
<li>null：InnoDB会遍历表去每一行的字段值，服务层判断是否为null，非null再累加</li>
</ul>
</li>
<li>COUNT(1)：InnoDB遍历整张表，但不取值。服务层对于返回的每一行。放一个数字 <code>1</code> 进去，直接按行进行累加。</li>
<li>COUNT(*)： InnoDB不会把每一行值全部字段都取出来，会进行优化，不取值。服务层直接按行累加</li>
</ul>
<p>按照效率对上述用法排序的话由高到低分别是 COUNT(*) ~&#x3D; COUNT(1) &gt; COUNT(主键) &gt; COUNT(字段)，在开发中应尽量使用  <code>COUNT(*)</code></p>
<h3 id="update优化"><a href="#update优化" class="headerlink" title="update优化"></a>update优化</h3><p>InnoDB的行锁时真多索引加的锁，不是针对记录的。若索引失效，或不存在，行锁就会升级成表锁。<br>所以在执行 <code>UPDATE</code> 语句时应使用索引作为更新的条件，否则会导致 <mark style="background: #FFF3A3A6;">行锁</mark> 升级为 <mark style="background: #FFB86CA6;">表锁</mark>。锁住整张表。</p>
<h2 id="视图-x2F-存储过程-x2F-触发器"><a href="#视图-x2F-存储过程-x2F-触发器" class="headerlink" title="视图&#x2F;存储过程&#x2F;触发器"></a>视图&#x2F;存储过程&#x2F;触发器</h2><h3 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h3><blockquote>
<p>视图是一种虚拟存在的表，视图中的数据并不存在与数据库中，行和列来自 <mark style="background: #FFB86CA6;">定义视图的查询中使用的表</mark>。且是使用时动态生成。<br>简单地说就是，视图只保存查询SQL的逻辑。不保存查询结果</p>
</blockquote>
<ul>
<li>创建视图：<code>CREATE [OR REPLACE] VIEW view_name AS SELECT语句 [WITH[CASCADED|LOCAL] CHECK OPTION]</code></li>
<li>查询视图<ul>
<li>查看视图创建语句：<code>SHOW CREATE VIEW view_name;</code></li>
<li>查询视图数据：视图是一种虚拟存在的表，所以和查询表一样使用 select 即可</li>
</ul>
</li>
<li>修改视图：与创建视图语句一样，只不过必须带上 <code>OR REPLACE</code></li>
<li>删除视图：<code>DROP VIEW [IF EXISTS] view_name....</code></li>
</ul>
<h4 id="检查选项-CASCADED"><a href="#检查选项-CASCADED" class="headerlink" title="检查选项(CASCADED)"></a>检查选项(CASCADED)</h4><ul>
<li>当创建视图时添加 <code>WITH CHECK OPTION</code> 子句，Mysql会通过视图检查正在更改的每个行，例如插入，更新，删除，使其符合视图的定义。例如：使用语句 <code>CREATE OR REPLACE VIEW user_v AS SELECT id,name,age FROM user WHERE age &gt; 24 WITH CASCADED CHECK OPTION;</code>创建视图。如果我们往这个视图插入数据 <code>INSERT INTO user_v values(10,&#39;jack&#39;,30);</code> 此时会插入失败，因为values的 <code>age</code> 字段值大于24，超出了视图 <code>user_v</code> 的定义。 </li>
<li>视图的创建是可以套娃的，一个视图可以基于另一个视图创建，例如<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> view_name_2 <span class="keyword">AS</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> view_name_1 <span class="keyword">WHERE</span> id <span class="operator">&gt;</span> <span class="number">10</span> <span class="keyword">WITH</span> <span class="keyword">CASCADED</span> <span class="keyword">CHECK</span> OPTION;</span><br></pre></td></tr></table></figure></div>
前面说过对进行增删改操作时，mysql会判断是否符合视图的定义。同时也会检查依赖视图（view_name_1）的规则。为了去顶检查范围。mysql提供了两个选项 <code>CASCADED</code> 和 <code>LOCAL</code><ul>
<li><code>CASCADED</code>：为默认值，表示更新视图时要满足所有相关视图和表的条件</li>
<li><code>LOCAL</code>：表示更新视图时满足该视图本身定义的条件即可</li>
</ul>
</li>
</ul>
<h4 id="作用和特点"><a href="#作用和特点" class="headerlink" title="作用和特点"></a>作用和特点</h4><ul>
<li><p>视图的列可以来自不同的表，是表的抽象和逻辑意义上建立的新关系</p>
</li>
<li><p>视图是由基本表（实表）产生的表（虚表）</p>
</li>
<li><p>视图的建立和删除不影响基本表</p>
</li>
<li><p>对视图内容的更新（增删改）直接影响基本表</p>
</li>
<li><p>当视图来自多个基本表，不允许添加和删除数据</p>
</li>
<li><p>表的安全：数据库可以授权，但不能授权到表中的特定列和行。通过视图可以让用户只能查询修改他们所能见到的数据。</p>
</li>
<li><p>数据独立：视图可以帮助用户屏蔽真实表的结构变化带来的影响</p>
</li>
<li><p>例子</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 定义一个视图，查询学生与选课信息，三表联查。</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> replace <span class="keyword">view</span> view_user_course <span class="keyword">as</span> <span class="keyword">select</span> u.name <span class="string">&#x27;学生&#x27;</span>, c.name <span class="string">&#x27;选修的课&#x27;</span> <span class="keyword">from</span> <span class="keyword">user</span> u, course c, user_course uc <span class="keyword">where</span> uc.userId <span class="operator">=</span> u.id <span class="keyword">and</span> uc.courseId <span class="operator">=</span> c.id;  </span><br><span class="line"><span class="comment">-- 定义视图之后，我们直接使用下面这个语句就可以了，就不用写三表联查的语句了</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> view_user_course;</span><br></pre></td></tr></table></figure></div></li>
</ul>
<blockquote>
<p>个人觉得有点像现在很多app都有的青少年模式，限制一些功能给其他人用，想修改数据就必须遵守视图的规则</p>
</blockquote>
<h3 id="存储过程"><a href="#存储过程" class="headerlink" title="存储过程"></a>存储过程</h3><p>存储过程时实现经过编译并存储在数据库中的一段SQL语句集合，我们可以直接调用这个存储过程以简化开发人员的工作。减少数据在数据库与应用服务器之间的传输。简单地说就是SQL语句的封装与重用。</p>
<ul>
<li>特点：SQL封装与复用，且可以传入参数与返回参数，减少网络交互，效率提升。</li>
</ul>
<blockquote>
<p>类似Java的封装</p>
</blockquote>
<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> getUser(userId <span class="type">INT</span>)  </span><br><span class="line"><span class="keyword">BEGIN</span>  </span><br><span class="line">    <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> userId;  </span><br><span class="line"><span class="keyword">END</span>;  </span><br><span class="line"><span class="comment">-- 使用  </span></span><br><span class="line"><span class="keyword">CALL</span> getUser(<span class="number">1</span>);</span><br><span class="line"><span class="comment">-- 查看指定表有哪些存储过程  </span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> information_schema..ROUTINES <span class="keyword">WHERE</span> ROUTINE_SCHEMA <span class="operator">=</span> <span class="string">&#x27;要查看的表名&#x27;</span>；  </span><br><span class="line"><span class="comment">-- 查看创建语句  </span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> get_user_course;  </span><br><span class="line"><span class="comment">-- 删除存储过程  </span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">PROCEDURE</span> IF <span class="keyword">EXISTS</span> procedure_name;</span><br></pre></td></tr></table></figure></div>

<h4 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h4><div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查看当前会话的系统变量  </span></span><br><span class="line"><span class="keyword">SHOW</span> SESSION VARIABLES;  </span><br><span class="line"><span class="comment">-- 查看以auto开头的全局系统变量，  </span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">GLOBAL</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;auto%&#x27;</span>;  </span><br><span class="line"><span class="comment">-- 精准查看全局变量 autocommit</span></span><br><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@global</span>.autocommit;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 设置当前会话的系统变量  </span></span><br><span class="line"><span class="keyword">SET</span> SESSION 系统变量名<span class="operator">=</span>值</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 用户变量赋值</span></span><br><span class="line"><span class="keyword">SET</span> @变量名<span class="operator">=</span>值...;  <span class="comment">-- 可以一次性设置多个变量</span></span><br><span class="line"><span class="keyword">SET</span> @变量名 :<span class="operator">=</span> 值;  </span><br><span class="line"><span class="keyword">SELECT</span> @变量名 :<span class="operator">=</span> 值;  </span><br><span class="line"><span class="comment">-- 将查询结果赋值给变量  </span></span><br><span class="line"><span class="keyword">SELECT</span> 字段名 <span class="keyword">INTO</span> @变量名 <span class="keyword">FROM</span> 表名;</span><br><span class="line"><span class="comment">-- 使用</span></span><br><span class="line"><span class="keyword">SELECT</span> @变量名;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 局部变量，访问前需要用DECLARE声明。可作为存储过程和输入参数，其作用域在定义变量的存储过程中</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> p1()  </span><br><span class="line"><span class="keyword">BEGIN</span>  </span><br><span class="line">    <span class="comment">-- DECLARE 变量名 变量类型 DEFAULT 默认值；  </span></span><br><span class="line">    <span class="keyword">DECLARE</span> a <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>;  </span><br><span class="line">    <span class="comment">-- 赋值,赋值与用户变量赋值一样  </span></span><br><span class="line">    <span class="keyword">SET</span> a <span class="operator">=</span> <span class="number">2</span>;  </span><br><span class="line">    <span class="comment">-- 局部变量的作用与为存储过程p1里，超出p1就失效  </span></span><br><span class="line"><span class="keyword">END</span>;</span><br></pre></td></tr></table></figure></div>

<h4 id="条件判断"><a href="#条件判断" class="headerlink" title="条件判断"></a>条件判断</h4><p>if判断没啥好说的</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> p2()  </span><br><span class="line"><span class="keyword">BEGIN</span>  </span><br><span class="line">    IF 条件<span class="number">1</span> <span class="keyword">THEN</span>  </span><br><span class="line">        <span class="comment">-- SQL语句  </span></span><br><span class="line">    ELSEIF 条件<span class="number">2</span> <span class="keyword">THEN</span>  </span><br><span class="line">        <span class="comment">-- SQL语句  </span></span><br><span class="line">    <span class="keyword">ELSE</span>  </span><br><span class="line">        <span class="comment">-- SQL语句  </span></span><br><span class="line">    <span class="keyword">END</span> IF;  </span><br><span class="line"><span class="keyword">END</span>;</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>设置时若没有指定 SESSION 或 GLOBAL 默认将会是 SESSION<br>mysql重启后所有设置的系统变量将失效，若想永久有效 可更改 my.cnf 文件</p>
</blockquote>
<h4 id="用户自定义变量"><a href="#用户自定义变量" class="headerlink" title="用户自定义变量"></a>用户自定义变量</h4><p>用户变量不用提前声明，在用的时候使用 <code>@变量名</code> 即可。其作用域为当前会话连接</p>
<h4 id="存储过程的参数"><a href="#存储过程的参数" class="headerlink" title="存储过程的参数"></a>存储过程的参数</h4><p>存储过程的参数除了数值类型外，还有一个参数类型</p>
<ul>
<li>IN：传入参数，调用时需要传入（默认）</li>
<li>OUT：该参数可以作为返回值</li>
<li>INOUT：该参数既是传入参数也可以做返回值</li>
</ul>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> p3([<span class="keyword">IN</span><span class="operator">/</span><span class="keyword">OUT</span><span class="operator">/</span><span class="keyword">INOUT</span>] arg INT...)  </span><br><span class="line"><span class="keyword">BEGIN</span>  </span><br><span class="line">    <span class="comment">-- SQL逻辑  </span></span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> p3(<span class="keyword">IN</span> arg1 <span class="type">INT</span>, <span class="keyword">OUT</span> arg2 <span class="type">VARCHAR</span>(<span class="number">10</span>))  </span><br><span class="line"><span class="keyword">BEGIN</span>  </span><br><span class="line">	IF arg1 <span class="operator">&gt;</span> <span class="number">10</span> <span class="keyword">THEN</span></span><br><span class="line">		<span class="keyword">SET</span> arg2 <span class="operator">=</span><span class="string">&#x27;返回值&#x27;</span>;</span><br><span class="line">	<span class="keyword">END</span> IF;</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line"><span class="comment">-- 调用</span></span><br><span class="line"><span class="keyword">CALL</span> p3(<span class="number">11</span>, <span class="variable">@RESULT</span>); <span class="comment">-- @RESULT 接受p3返回结果</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@RESULT</span> <span class="comment">-- 查看结果</span></span><br></pre></td></tr></table></figure></div>

<h4 id="CASE"><a href="#CASE" class="headerlink" title="CASE"></a>CASE</h4><blockquote>
<p>类似Java的 <code>switch</code></p>
</blockquote>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> p4(<span class="keyword">month</span> <span class="type">int</span>)  </span><br><span class="line"><span class="keyword">BEGIN</span>  </span><br><span class="line">    <span class="keyword">DECLARE</span> <span class="keyword">result</span> <span class="type">varchar</span>(<span class="number">10</span>);  </span><br><span class="line">    <span class="keyword">CASE</span></span><br><span class="line">	    <span class="keyword">WHEN</span> <span class="keyword">month</span> <span class="operator">=</span> <span class="number">1</span> <span class="keyword">THEN</span> <span class="keyword">SET</span> <span class="keyword">result</span> :<span class="operator">=</span> <span class="string">&#x27;一月&#x27;</span>;  </span><br><span class="line">        <span class="keyword">WHEN</span> <span class="keyword">month</span> <span class="operator">=</span> <span class="number">2</span> <span class="keyword">THEN</span> <span class="keyword">SET</span> <span class="keyword">result</span> :<span class="operator">=</span> <span class="string">&#x27;二月&#x27;</span>;  </span><br><span class="line">        <span class="keyword">WHEN</span> <span class="keyword">month</span> <span class="operator">=</span> <span class="number">3</span> <span class="keyword">THEN</span> <span class="keyword">SET</span> <span class="keyword">result</span> :<span class="operator">=</span> <span class="string">&#x27;三月&#x27;</span>;</span><br><span class="line">        <span class="keyword">ELSE</span> <span class="keyword">SET</span> <span class="keyword">result</span> :<span class="operator">=</span> <span class="string">&#x27;输入错误&#x27;</span>; <span class="comment">-- switch的default</span></span><br><span class="line">    <span class="keyword">END</span> <span class="keyword">CASE</span>;</span><br><span class="line"><span class="keyword">END</span>;</span><br></pre></td></tr></table></figure></div>

<h3 id="存储函数"><a href="#存储函数" class="headerlink" title="存储函数"></a>存储函数</h3><p>存储函数是<mark style="background: #FFF3A3A6;">有返回值的存储过程</mark> 存储函数的参数只能是 <code>IN</code> 类型的。语法如下</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> function_name (参数列表)  </span><br><span class="line"><span class="keyword">RETURNS</span> return_type [characteristic...]   <span class="comment">-- 返回类型  </span></span><br><span class="line"><span class="keyword">BEGIN</span>  </span><br><span class="line">    <span class="comment">-- SQL 语句  </span></span><br><span class="line">    <span class="keyword">RETURN</span> 返回值  </span><br><span class="line"><span class="keyword">END</span>;</span><br></pre></td></tr></table></figure></div>

<p>characteristic（返回值特性）说明</p>
<ul>
<li>DETERMINISTIC：相同的输入参数总是产生相同的结果</li>
<li>NO SQL：不包含SQL语句</li>
<li>READS SQL DATA：包含读取数据的语句，但不包含写入数据的语句</li>
</ul>
<h3 id="触发器"><a href="#触发器" class="headerlink" title="触发器"></a>触发器</h3><blockquote>
<p>与数据库表有关的数据库对象，在INSERT&#x2F;UPDATE&#x2F;DELETE之前或之后触发并执行触发器中定义的SQL语句集合。可以协助应用在数据端确保数据完整性，日志记录，数据校验等操作。</p>
</blockquote>
<ul>
<li>使用别名 OLD 和 NEW 来引用触发器中发生变化的记录内容。触发器支支持行级触发，不支持语句触发（指一个SQL操作影响了5行数据，那么将触发5次）</li>
</ul>
<table>
<thead>
<tr>
<th>触发器类型</th>
<th>NEW和OLD</th>
</tr>
</thead>
<tbody><tr>
<td>INSERT触发器</td>
<td>NEW 表示新增数据</td>
</tr>
<tr>
<td>UPDATE触发器</td>
<td>OLD表示修改前的数据，NEW表示将要修改或修改后的数据</td>
</tr>
<tr>
<td>DELETE触发器</td>
<td>OLD表示将要删除或已删除的数据</td>
</tr>
</tbody></table>
<ul>
<li>创建触发器<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- user 插入数据前触发 BEFORE操作前触发 AFTER操作后触发。INSERT 可换UPDATE, DELETE</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trigger_name BEFORE <span class="keyword">INSERT</span> <span class="keyword">ON</span> <span class="keyword">user</span> <span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span>  </span><br><span class="line"><span class="keyword">BEGIN</span>  </span><br><span class="line">    <span class="comment">-- 触发器逻辑，当user插入新数据时，将插入数据的id与name字段保存到user_log表中</span></span><br><span class="line">    <span class="comment">-- NEW指插入user表的那行数据，因为这个是插入型触发器，UPDATE与DELETE的OLD同理</span></span><br><span class="line">    <span class="keyword">INSERT</span> <span class="keyword">INTO</span> user_log <span class="keyword">VALUES</span> (NEW.id, NEW.name); </span><br><span class="line"><span class="keyword">END</span>;</span><br></pre></td></tr></table></figure></div></li>
</ul>
<h2 id="锁"><a href="#锁" class="headerlink" title="锁"></a>锁</h2><blockquote>
<p>数据库里面的锁是基于索引实现的，在Innodb中我们的锁都是作用在索引上面的，当我们的SQL命中索引时，那么锁住的就是命中条件内的索引节点(行锁)，如果没有命中索引的话，那我们锁的就是整个索引树（表锁）</p>
</blockquote>
<ul>
<li>加锁：<code>LOCK TABLES 表名... READ/WRITE;</code></li>
<li>解锁：<code>UNLOCK TABLES / 客户端断开链接</code></li>
</ul>
<h3 id="全局锁"><a href="#全局锁" class="headerlink" title="全局锁"></a>全局锁</h3><blockquote>
<p>锁定整个数据库中的所有表，<mark style="background: #FFB8EBA6;">加锁后mysql处于只读状态</mark>。对于DML&#x2F;DDL以及事务提交的操作都会被阻塞。一般用于数据库的全局备份</p>
</blockquote>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 加全局锁（mysql命令行下）</span></span><br><span class="line">FLUSH TABLES <span class="keyword">WITH</span> READ LOCK;</span><br><span class="line"><span class="comment">-- 备份数据库，这个命令不是mysql的，用终端运行</span></span><br><span class="line">mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p密码 要备份的数据库名 <span class="operator">&gt;</span> 备份保存路径</span><br><span class="line"><span class="comment">-- 解锁 （mysql命令行下）</span></span><br><span class="line">UNLOCK TABLES;</span><br></pre></td></tr></table></figure></div>
<ul>
<li>全局锁会导致增删改操作的阻塞。如果数据库设置了主从同步。我们备份是要在从库上进行（主库增删改，从库查询），但<mark style="background: #FFB86CA6;">备份期间是无法进行主从复制的</mark>，会导致主从延迟。</li>
<li>在InnoDB引擎中，我们可以在备份时附加参数 <code>--single-transaction</code> 来完成不加锁的一致性数据备份</li>
</ul>
<h3 id="共享锁"><a href="#共享锁" class="headerlink" title="共享锁"></a>共享锁</h3><ul>
<li>共享锁又称读锁。当一个事务给数据加上读锁之后，其他事务只能对数据加读锁，不能对数据加写锁，直到所有读锁释放后才能加写锁<br>共享锁的作用是用于并发时的数据读取，读取数据时不允许修改。加锁期间任何操作只能读不能改</li>
</ul>
<h3 id="排他锁"><a href="#排他锁" class="headerlink" title="排他锁"></a>排他锁</h3><ul>
<li>排他锁又称写锁。当一个事务给数据加上写锁后，其他事务就不能添加任何锁，直到写锁释放。<br>排他锁的作用是在修改数据时不允许同时修改，也不允许读取。避免出现脏读和脏数据的问题。</li>
</ul>
<h3 id="元数据锁（Meta-Data-Lock，MDL）"><a href="#元数据锁（Meta-Data-Lock，MDL）" class="headerlink" title="元数据锁（Meta Data Lock，MDL）"></a>元数据锁（Meta Data Lock，MDL）</h3><p>MDL加锁过程是系统自动控制的，无需显示使用，在访问一张表时会自动加上。MDL锁的主要作用时维护表元数据（表结构）的一致性。在表有活动事务时，不可以对元数据进行更改操作。简单地说就是锁表的结构，当有客户端在增删改查表的时候，禁止修改表结构（添加删除字段等）</p>
<table>
<thead>
<tr>
<th>对应操作SQL</th>
<th>锁类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>LOCK TABLES table_name READ&#x2F;WRITE</td>
<td>SHARED_READ_ONLY&#x2F;SHARED_NO_READ_ONLY</td>
<td></td>
</tr>
<tr>
<td>SELECT,SELECT …LOCK IN SHARE MODE</td>
<td>SHARED_READ</td>
<td>与EXCLUSIVE互斥</td>
</tr>
<tr>
<td>INSERT,UPDATE,DELETE,SELECT …FOR UPDATE</td>
<td>SHARED_WRITE</td>
<td>与EXCLUSIVE互斥</td>
</tr>
<tr>
<td>ALTER TABLE</td>
<td>EXCLUSIVE</td>
<td>与其他MDL互斥</td>
</tr>
</tbody></table>
<blockquote>
<p>SHARED_READ 和 SHARED_WRITE 是互相兼容的</p>
</blockquote>
<ul>
<li>查看表的元数据锁，通过此语句可以查看当前mysql有哪些元数据锁<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> OBJECT_TYPE,OBJECT_SCHEMA,OBJECT_NAME,LOCK_TYPE,LOCK_DURATION <span class="keyword">FROM</span> performance_schema.metadata_locks;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+--------------------+----------------+---------------------+---------------+</span></span><br><span class="line"><span class="operator">|</span> OBJECT_TYPE <span class="operator">|</span> OBJECT_SCHEMA      <span class="operator">|</span> OBJECT_NAME    <span class="operator">|</span> LOCK_TYPE           <span class="operator">|</span> LOCK_DURATION <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+--------------------+----------------+---------------------+---------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">TABLE</span>       <span class="operator">|</span> test               <span class="operator">|</span> <span class="keyword">user</span>           <span class="operator">|</span> SHARED_WRITE        <span class="operator">|</span> TRANSACTION   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> SCHEMA      <span class="operator">|</span> test               <span class="operator">|</span> <span class="keyword">NULL</span>           <span class="operator">|</span> INTENTION_EXCLUSIVE <span class="operator">|</span> TRANSACTION   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">TABLE</span>       <span class="operator">|</span> test               <span class="operator">|</span> class          <span class="operator">|</span> SHARED_READ         <span class="operator">|</span> TRANSACTION   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">TABLE</span>       <span class="operator">|</span> performance_schema <span class="operator">|</span> metadata_locks <span class="operator">|</span> SHARED_READ         <span class="operator">|</span> TRANSACTION   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+--------------------+----------------+---------------------+---------------+</span></span><br></pre></td></tr></table></figure></div></li>
</ul>
<h3 id="表锁"><a href="#表锁" class="headerlink" title="表锁"></a>表锁</h3><ul>
<li>指上锁时锁住整张表，即锁住整个索引树。当其他事务访问该表时，必须等待加锁的事务释放锁。<mark style="background: #BBFABBA6;">加锁粒度大，但容易冲突</mark></li>
</ul>
<h3 id="行锁"><a href="#行锁" class="headerlink" title="行锁"></a>行锁</h3><ul>
<li>指上锁时锁住表的某一行或某几行记录。其他事务访问表时，只有加锁的几行记录不能访问，其他是可以访问的。加锁粒度小，不容易冲突，相比表锁支持的并发要高些</li>
</ul>
<table>
<thead>
<tr>
<th>SQL操作</th>
<th>行锁类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>INSERT</td>
<td>排他锁</td>
<td>自动加锁</td>
</tr>
<tr>
<td>UPDATE</td>
<td>排他锁</td>
<td>自动加锁</td>
</tr>
<tr>
<td>DELETE</td>
<td>排他锁</td>
<td>自动加锁</td>
</tr>
<tr>
<td>SELECT</td>
<td>不加锁</td>
<td></td>
</tr>
<tr>
<td>SELECT…LOCK IN SHARE MODE</td>
<td>共享锁</td>
<td>手动加锁，添加LOCK IN SHARE MODE</td>
</tr>
<tr>
<td>SELECT…FOR UPDATE</td>
<td>排他锁</td>
<td>手动枷锁，添加FOR UPDATE</td>
</tr>
</tbody></table>
<ul>
<li>因为InnoDB是根据索引来加锁的，如果SQL语句 WHERE 后面的条件没有使用索引字段，那么行锁就会升级成表锁。例如下面这样<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 如果name有关联字段那么mysql会给name=lily这行加锁，如果name没有关联字段，那么mysql就会给user表加表锁</span></span><br><span class="line"><span class="keyword">UPDATE</span> <span class="keyword">user</span> <span class="keyword">SET</span> name<span class="operator">=</span><span class="string">&#x27;jack&#x27;</span> <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;lily&#x27;</span>;</span><br><span class="line"><span class="comment">-- 此时如果有其它事务操作 user表，操作其他的行数据，那么这个操作会被阻塞。</span></span><br><span class="line"><span class="keyword">UPDATE</span> <span class="keyword">user</span> <span class="keyword">SET</span> name<span class="operator">=</span><span class="string">&#x27;taka&#x27;</span> <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span>; <span class="comment">-- 操作会被阻塞</span></span><br></pre></td></tr></table></figure></div></li>
</ul>
<h3 id="记录锁"><a href="#记录锁" class="headerlink" title="记录锁"></a>记录锁</h3><ul>
<li>记录锁是行锁的一种，只不过其加锁范围是表中的某一条数据(只锁一条)，粒度精确条件命中，命中条件是唯一索引。<br>例如：<code>UPDATE user SET name=&#39;jack&#39; WHERE id=1;</code><br>记录所的作用是：加锁的数据可以避免数据在查询时被修改的重复读问题，也避免了脏读</li>
</ul>
<h3 id="间隙锁"><a href="#间隙锁" class="headerlink" title="间隙锁"></a>间隙锁</h3><ul>
<li>间隙锁也是行锁的一种，其<mark style="background: #BBFABBA6;">锁定范围是表的某一个区间</mark>。当表的相邻id之间出现空隙就会形成一个区间，遵循左开右闭原则。例如表中有数据ID为 <code>1，3，5，7</code> 会形成以下区间 <code>(-infinity,1]</code> <code>(1,3]</code> <code>(3,5]</code> <code>(5,7]</code> <code>(7,infinity]</code></li>
<li>触发条件是范围查询且未命中，查询条件必须使用索引，例如 <code>SELECT * FROM user WHERE id &gt; 1 AND id &lt; 3 FOR UPDATE;</code> 很明显表中并没有满足条件的数据，这时就会使用间隙锁。间隙锁作用是解决在隔离等级为 <code>Repeatable Read(可重复读)</code> 级别下的幻读问题。</li>
<li>简单地所就是操作时给区间内不存在的数据加锁，防止其他事务插入数据到这些区间中出现幻读。</li>
</ul>
<h3 id="临键锁"><a href="#临键锁" class="headerlink" title="临键锁"></a>临键锁</h3><ul>
<li>临键锁也属于行锁的一种，是InnoDB的行锁默认算法，是记录锁和间隙锁的组合。锁的范围是行数据与区间</li>
<li>触发条件：范围查询且命中，查询使用了索引。例如 &#96;SELECT * FROM user WHERE id &gt; 5 AND id &lt;&#x3D; 7 FOR UPDATE;</li>
<li>作用：避免了在范围查询时出现脏读、重复读、幻读问题。加了临键锁之后，在范围区间内数据不允许被修改和插入</li>
<li>如果查询条件没有命中索引，那么临建锁会退化成间隙锁</li>
</ul>
<h3 id="意向锁"><a href="#意向锁" class="headerlink" title="意向锁"></a>意向锁</h3><ul>
<li>在开发中我们会遇到这种情况，客户端A开启事务对表 <code>user</code> 执行 <code>UPDATE</code> 操作，此时mysql会自动给涉及的数据行添加 <code>行锁</code> 。此时事务还未提交，客户端B要给表 <code>user</code> 添加了表锁。这时候mysql会检查表的每一行，查看是否有行锁以及锁类型，这样效率明显是不高的。为了避免DML在执行时，加的行锁与表锁冲突。InnoDB引入了 <code>意向锁</code> 使表不用检查每行数据是否加锁，以此来减少对表的检查</li>
<li>意向共同共享锁（IS）：由语句SELECT … LOCK IN SHARE MODE</li>
<li>意向排他锁（IX）：由INSERT, UPDATE, DELETE, SELECT … FOR UPDATE添加</li>
<li><mark style="background: #ADCCFFA6;">描述是否可以对一个表进行加锁</mark></li>
</ul>
<p>举个栗子，假设行锁和表锁能够共存，事务A锁住了表中某一行，而事务B锁住了整张表。但这时你就会发现问题。事务A锁住了某一行，代表着其他事务不能修改这一行。而事务B锁住了表，代表着事务B能任意修改表中的任意一行。这与事务A的行锁发生了冲突。这是在没有意向锁的情况下。<br>那有意向锁了后，前面栗子中的事务A在申请行锁之前，mysql就会自动先给事务A申请表的意向排他锁。当事务B去申请表的写锁时就会失败被阻塞。<br>所以意向锁的作用是，当有一个事务申请给数据加锁时，如果</p>
<h2 id="InnoDB引擎"><a href="#InnoDB引擎" class="headerlink" title="InnoDB引擎"></a>InnoDB引擎</h2><h3 id="逻辑存储结构"><a href="#逻辑存储结构" class="headerlink" title="逻辑存储结构"></a>逻辑存储结构</h3><p>InnoDB存储结构如下图<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2023/03/24/VlFQhOdW3TmkERn.png"
                      alt="a.png"
                ></p>
<blockquote>
<p>如上图所示，页中存储的是行数据，页可以为空，可以只填一部分，当然也可以全部填满。每个页包含了 <code>2-n</code> 行数据，根据据主键排列。</p>
</blockquote>
<h3 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h3><p>InnoDB架构图如下<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://dev.mysql.com/doc/refman/8.0/en/images/innodb-architecture-8-0.png"
                     
                ></p>
<h4 id="内存结构（左侧）"><a href="#内存结构（左侧）" class="headerlink" title="内存结构（左侧）"></a>内存结构（左侧）</h4><h5 id="Buffer-Pool"><a href="#Buffer-Pool" class="headerlink" title="Buffer Pool"></a>Buffer Pool</h5><p>缓冲池是主内存中的一个区域，里面可以缓存磁盘上经常操作的真实数据，在执行增删改查时，先操作缓冲池中的数据（若缓冲池没有，就从磁盘加载并缓存）。然后再以一定频率刷新到磁盘，减少磁盘IO。<br>缓冲池以 <code>页（Page）</code> 为单位，底层采用链表数据结构管理Page。根据状态可分为三种类型</p>
<ul>
<li>free page：空闲page，未被使用</li>
<li>clean page：被使用page，数据没有被修改过</li>
<li>dirty page：脏页，被使用page，数据被修改过，且和磁盘中的数据不一致。</li>
</ul>
<h5 id="Change-Buffer"><a href="#Change-Buffer" class="headerlink" title="Change Buffer"></a>Change Buffer</h5><p>更改缓冲区（针对非唯一的二级索引页）在执行DML语句时，如果这些数据Page没有在Buffer Pool中，不会直接操作磁盘，而会将数据的变更存在更改缓冲区Change Buffer中。在未来读取数据时再将数据合并到BuffPool中，然后把合并后的数据刷入磁盘。</p>
<blockquote>
<p>Change Buffer的意义：与聚集索引不同，二级索引通常是非唯一，且是以相对随机的顺序插入的。同时删除和更新可能影响索引树中不相邻的二级索引页，如果每一次都操作磁盘，会造成大量的磁盘IO浪费。而有了Change Buffer后就可以在缓冲池中进行合并处理再写入磁盘。减少IO</p>
</blockquote>
<h5 id="Log-Buffer"><a href="#Log-Buffer" class="headerlink" title="Log Buffer"></a>Log Buffer</h5><p>日志缓冲区：用来保存要写入磁盘中的log日志数据（redo log， undo log）。默认大小为 <code>16m</code>。日志缓冲区的日志会定期刷新到磁盘中。如果需要更新、插入、删除许多行的事务，增加日志缓冲区的大小可以节省磁盘IO<br><code>innodn_log_buffer_size</code>：日志缓冲区大小<br><code>innodb_flush_log_at_trx_commit</code>：日志刷新到磁盘的时机<br>            - 值可选 <code>1</code> <code>0</code> <code>2</code><br>            - 1：日志在每次事务提交时写入并刷新磁盘<br>            - 0：每秒将日志写入并刷新到磁盘一次<br>            - 2：日志在每次事务提交后写入，并每秒刷新到磁盘一次</p>
<h5 id="Adaptive-Hash-Index"><a href="#Adaptive-Hash-Index" class="headerlink" title="Adaptive Hash Index"></a>Adaptive Hash Index</h5><p>自适应索引，用于优化对 <code>Buffer Pool</code> 数据的查询，InnoDB会监控表上各索引页的查询，如果观察到hash索引可以提升速度，则会自动建立hash索引。InnoDB根据情况自动完成</p>
<h4 id="磁盘结构（右侧）"><a href="#磁盘结构（右侧）" class="headerlink" title="磁盘结构（右侧）"></a>磁盘结构（右侧）</h4><h5 id="System-Tablespace"><a href="#System-Tablespace" class="headerlink" title="System Tablespace"></a>System Tablespace</h5><p>系统表空间是更改缓存区的存储区域。如果表是在系统表空间而不是每张表文件或通用表空间中创建的，它也可能包含表和索引的数据</p>
<ul>
<li>参数 <code>innodb_data_file_path</code>：指定innodb tablespace文件（.ibd）</li>
</ul>
<h5 id="File-Per-Table-Tablespaces"><a href="#File-Per-Table-Tablespaces" class="headerlink" title="File-Per-Table- Tablespaces"></a>File-Per-Table- Tablespaces</h5><p>每张表的独立表空间（默认开启），每个表的文件表空间包含单个InnoDB表的数据结构和索引，并存储在文件系统上的单个数据文件中</p>
<ul>
<li>参数 <code>innodb_file_per_table</code></li>
</ul>
<h5 id="General-Tablespaces"><a href="#General-Tablespaces" class="headerlink" title="General Tablespaces"></a>General Tablespaces</h5><p>通用表空间，需要通过 <code>CREATE TABLESPACE xxxx ADD DATAFILE &#39;file_name&#39; ENGINE=&#39;engine_name&#39;</code> 创建通用表空间，在创建表时可以指定该表空间 <code>CREATE TABLE xxx... TABLESPACE table_space_name;</code> 指定表空间后，这个表的数据就会存储在这个表空间中。</p>
<h5 id="Undo-Tablespaces"><a href="#Undo-Tablespaces" class="headerlink" title="Undo Tablespaces"></a>Undo Tablespaces</h5><p>撤销表空间：mysql在初始化时会自动创建两个默认的undo表空间（初始大小16m）用于存储undo log日志</p>
<h5 id="Temporary-Tablespaces"><a href="#Temporary-Tablespaces" class="headerlink" title="Temporary Tablespaces"></a>Temporary Tablespaces</h5><p>临时表空间，InnoDB使用会话临时表空间和全局临时表空间。存储用户创建的临时表等数据。</p>
<h5 id="Doublewrite-Buffer-Files"><a href="#Doublewrite-Buffer-Files" class="headerlink" title="Doublewrite Buffer Files"></a>Doublewrite Buffer Files</h5><p>双写缓冲区，InnoDB引擎将数据页从Buffer Pool刷新到磁盘前，先将数据页写入双写缓冲区文件中，便于系统异常时恢复数据。磁盘文件为 <code>#ib_16384_0.dblwr</code> 和 <code>#ib_16384_1.dblwr</code></p>
<h5 id="Redo-Log"><a href="#Redo-Log" class="headerlink" title="Redo Log"></a>Redo Log</h5><p>重做日志，是用来实现事务的持久性。该日志由两部分组成。</p>
<ol>
<li>重做日志缓冲（redo log buffer）在内存中</li>
<li>重做日志文件（redo log）在磁盘中<br>当事务提交之后就会把所有修改信息都存到该日志中，用于在刷新脏页和磁盘时发生错误时，进行数据恢复。涉及的文件 <code>ib_logfile0</code> 和 <code>ib_logfile1</code></li>
</ol>
<h5 id="后台线程"><a href="#后台线程" class="headerlink" title="后台线程"></a>后台线程</h5><p>作用是在合适的时机，将缓冲池的数据刷入磁盘</p>
<h6 id="Master-Thread"><a href="#Master-Thread" class="headerlink" title="Master Thread"></a>Master Thread</h6><p>核心后台线程，负责调度其他线程，还负责将缓冲池中的数据异步刷新到磁盘中，保持数据一致性。也包括脏页刷新，合并插入缓存，undo页的回收</p>
<h6 id="IO-Thread"><a href="#IO-Thread" class="headerlink" title="IO Thread"></a>IO Thread</h6><p>InnoDB大量使用了AIO（Async IO 异步非阻塞IO）来处理IO请求。而IO Thread主要负责这些IO请求的回调</p>
<table>
<thead>
<tr>
<th>线程类型</th>
<th>默认数量</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>Read Thread</td>
<td>4</td>
<td>负责读操作</td>
</tr>
<tr>
<td>Write Thread</td>
<td>4</td>
<td>负责写操作</td>
</tr>
<tr>
<td>Log Thread</td>
<td>1</td>
<td>负责将日志缓冲区刷新到磁盘</td>
</tr>
<tr>
<td>Insert Buffer Thread</td>
<td>1</td>
<td>负责将写缓冲区刷新到磁盘</td>
</tr>
</tbody></table>
<h6 id="Purge-Thread"><a href="#Purge-Thread" class="headerlink" title="Purge Thread"></a>Purge Thread</h6><p>主要用于回收事务已提交的undo log，事务提交后，undo log可能不用了，所以此线程就回收掉</p>
<h6 id="Page-Cleaner-Thread"><a href="#Page-Cleaner-Thread" class="headerlink" title="Page Cleaner Thread"></a>Page Cleaner Thread</h6><p>协助Master Thread刷新脏页到磁盘的线程，减轻Master Thread的压力，减少阻塞</p>
<h3 id="事务原理"><a href="#事务原理" class="headerlink" title="事务原理"></a>事务原理</h3><blockquote>
<p>事务有四大特性： 原子性，一致性，持久性，隔离性。其中原子性，一致性，持久性是由 <code>redo log</code> 和 <code>undo log</code> 来实现的。而隔离性是通过 <code>锁</code> 和 <code>mvcc(多版本并发控制)</code> 来实现的<br>原子性：undo log<br>持久性：redo log<br>一致性：undo log + redo log<br>隔离性：mvcc + 锁</p>
</blockquote>
<h4 id="Redo-Log-1"><a href="#Redo-Log-1" class="headerlink" title="Redo Log"></a>Redo Log</h4><p>重做日志记录的是事务提交时的物理修改，是<mark style="background: #ABF7F7A6;">用来实现事务持久性</mark>的。该日志文件由两部分组成：重做日志缓冲（redo log buffer）和重做日志文件（redo log file），前者在内存中，后者在磁盘中。当事务提交后会把所有的修改信息都存到日志文件中</p>
<h4 id="Undo-Log"><a href="#Undo-Log" class="headerlink" title="Undo Log"></a>Undo Log</h4><ul>
<li>回滚日志，用于记录数据被修改前的信息。作用：<mark style="background: #BBFABBA6;">提供回滚</mark> and <mark style="background: #BBFABBA6;">MVCC</mark><br>undo log 和 redo log记录物理日志不一样，它是逻辑日志。例如：当你执行完一条DELETE语句删除一条数据后，undo log会记录一条对应的INSERT记录。就是与你操作相反的记录。当执行回滚时，就可以从undo log里读取相应记录并回滚。</li>
<li>undo log销毁：在事务执行时产生，事务提交后不会立刻删除，会检查undo log的记录是否涉及到mvcc（具体查看下方mvcc）</li>
<li>undo log存储：undo log采用段的方式进行管理和记录。存放在 rollback segment 回滚段中，内部包含 1024 个undo log segment</li>
</ul>
<h3 id="MVCC"><a href="#MVCC" class="headerlink" title="MVCC"></a>MVCC</h3><ul>
<li><p>当前读：读取的记录是记录的最新版本，读取时还要保证其他并发事务不能修改当前记录，会对读取的记录加锁。如：select … lock in share mode(共享锁)，select… for update，insert，update，delete(排他锁)都是一种当前读</p>
</li>
<li><p>快照读：正常的select（不加锁）就是快照读，读取的是记录数据的可见版本，有可能额是历史数据。不加锁，所以是非阻塞读。</p>
<ul>
<li>Read committed：每次select都生成一个快照读</li>
<li>Repeatable read：开启事务后第一个select语句才是快照读</li>
<li>Serializable：快照读会退化为当前读</li>
</ul>
</li>
<li><p>MVCC：多版本并发控制。指维护一个数据的多个版本，是的读写操作没冲突，快照读为mysql实现mvcc提供了非阻塞功能。具体实现依赖于：三个隐式字段，undo log日志、readView</p>
</li>
<li><p>三个隐藏字段：我们创建表的时候除了我们自己的业务字段，InnoDB还会添加三个隐式字段，分别是 <code>DB_TRX_ID</code> <code>DB_ROLL_PTR</code> <code>DB_ROW_ID</code></p>
</li>
</ul>
<table>
<thead>
<tr>
<th></th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>DB_TRX_ID</td>
<td>最近修改事务ID，最后一次修改此记录的事务ID</td>
</tr>
<tr>
<td>DB_ROLL_PTR</td>
<td>回滚指针，指向这条记录的上一个版本，用于配合undo log</td>
</tr>
<tr>
<td>DB_ROW_ID</td>
<td>隐藏主键，若用户没有指定主键，则会生成这个隐藏字段当主键</td>
</tr>
</tbody></table>
<h5 id="undo-log"><a href="#undo-log" class="headerlink" title="undo log"></a>undo log</h5><p>前面讲到，undo log的作用是操作发生错误时能够进行数据回滚。<br>当INSERT时，产生的undo log只在回滚时需要，事务提交后可以立刻删除<br>而当UPDATE，DELETE时，产生的undo log日志不仅在回滚时需要，在快照读时也需要。所以不会立刻被删除</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2023/03/24/CWXGHETSdtfqzgV.png"
                      alt="image.png"
                ></p>
<h5 id="read-view"><a href="#read-view" class="headerlink" title="read view"></a>read view</h5><p>读视图，是快照读SQL执行时MVCC数据提取的依据，记录并维护系统当前活跃事务（未提交的）的ID</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>m_ids</td>
<td>当前活跃事务的ID集合</td>
</tr>
<tr>
<td>min_trx_id</td>
<td>最小活跃事务ID</td>
</tr>
<tr>
<td>max_trx_id</td>
<td>预分配事务ID, 当前最大事务ID+1</td>
</tr>
<tr>
<td>creator_trx_id</td>
<td>ReadView创建者的事务ID</td>
</tr>
</tbody></table>
<ul>
<li>版本访问规则<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2023/03/24/5Duo2kKPCUjfLv9.png"
                     
                ></li>
</ul>

            </div>

            

            
                <ul class="post-tags-box">
                    
                        <li class="tag-item">
                            <a href="/tags/note/">#note</a>&nbsp;
                        </li>
                    
                        <li class="tag-item">
                            <a href="/tags/mysql/">#mysql</a>&nbsp;
                        </li>
                    
                </ul>
            

            

            
                <div class="article-nav">
                    
                        <div class="article-prev">
                            <a class="prev"
                            rel="prev"
                            href="/mysql-note/mysql%E7%AC%94%E8%AE%B01/"
                            >
                                <span class="left arrow-icon flex-center">
                                    <i class="fa-solid fa-chevron-left"></i>
                                </span>
                                <span class="title flex-center">
                                    <span class="post-nav-title-item">Mysql笔记1</span>
                                    <span class="post-nav-item">Prev posts</span>
                                </span>
                            </a>
                        </div>
                    
                    
                        <div class="article-next">
                            <a class="next"
                            rel="next"
                            href="/mysql-note/%E4%BA%8B%E5%8A%A1/"
                            >
                                <span class="title flex-center">
                                    <span class="post-nav-title-item">Mysql笔记-事务</span>
                                    <span class="post-nav-item">Next posts</span>
                                </span>
                                <span class="right arrow-icon flex-center">
                                    <i class="fa-solid fa-chevron-right"></i>
                                </span>
                            </a>
                        </div>
                    
                </div>
            


            
        </div>

        
            <div class="toc-content-container">
                <div class="post-toc-wrap">
    <div class="post-toc">
        <div class="toc-title">On this page</div>
        <div class="page-title">Mysql笔记2</div>
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Mysql%E7%9A%84%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84"><span class="nav-text">Mysql的体系结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E"><span class="nav-text">存储引擎</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84%E4%B8%89%E4%B8%AA%E5%BC%95%E6%93%8E%E7%89%B9%E7%82%B9"><span class="nav-text">常见的三个引擎特点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E7%9A%84%E9%80%89%E6%8B%A9"><span class="nav-text">存储引擎的选择</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95"><span class="nav-text">索引</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E6%A6%82%E8%BF%B0"><span class="nav-text">索引概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E7%BB%93%E6%9E%84"><span class="nav-text">索引结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E5%88%86%E7%B1%BB"><span class="nav-text">索引分类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E4%BD%BF%E7%94%A8"><span class="nav-text">索引使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SQL%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90"><span class="nav-text">SQL性能分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E4%BD%BF%E7%94%A8-1"><span class="nav-text">索引使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E5%88%9B%E5%BB%BA%E7%9A%84%E5%8E%9F%E5%88%99"><span class="nav-text">索引创建的原则</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SQL%E4%BC%98%E5%8C%96"><span class="nav-text">SQL优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE%E4%BC%98%E5%8C%96"><span class="nav-text">插入数据优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E9%94%AE%E4%BC%98%E5%8C%96"><span class="nav-text">主键优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#order-by-%E4%BC%98%E5%8C%96"><span class="nav-text">order by 优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#group-by-%E4%BC%98%E5%8C%96"><span class="nav-text">group by 优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#limit%E4%BC%98%E5%8C%96"><span class="nav-text">limit优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#count%E4%BC%98%E5%8C%96"><span class="nav-text">count优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#update%E4%BC%98%E5%8C%96"><span class="nav-text">update优化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%86%E5%9B%BE-x2F-%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B-x2F-%E8%A7%A6%E5%8F%91%E5%99%A8"><span class="nav-text">视图&#x2F;存储过程&#x2F;触发器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%86%E5%9B%BE"><span class="nav-text">视图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="nav-text">存储过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%98%E5%82%A8%E5%87%BD%E6%95%B0"><span class="nav-text">存储函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A6%E5%8F%91%E5%99%A8"><span class="nav-text">触发器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%94%81"><span class="nav-text">锁</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%A8%E5%B1%80%E9%94%81"><span class="nav-text">全局锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B1%E4%BA%AB%E9%94%81"><span class="nav-text">共享锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%92%E4%BB%96%E9%94%81"><span class="nav-text">排他锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%83%E6%95%B0%E6%8D%AE%E9%94%81%EF%BC%88Meta-Data-Lock%EF%BC%8CMDL%EF%BC%89"><span class="nav-text">元数据锁（Meta Data Lock，MDL）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A1%A8%E9%94%81"><span class="nav-text">表锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A1%8C%E9%94%81"><span class="nav-text">行锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%B0%E5%BD%95%E9%94%81"><span class="nav-text">记录锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%B4%E9%9A%99%E9%94%81"><span class="nav-text">间隙锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%B4%E9%94%AE%E9%94%81"><span class="nav-text">临键锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%84%8F%E5%90%91%E9%94%81"><span class="nav-text">意向锁</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#InnoDB%E5%BC%95%E6%93%8E"><span class="nav-text">InnoDB引擎</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%BB%E8%BE%91%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84"><span class="nav-text">逻辑存储结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%B6%E6%9E%84"><span class="nav-text">架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8B%E5%8A%A1%E5%8E%9F%E7%90%86"><span class="nav-text">事务原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MVCC"><span class="nav-text">MVCC</span></a></li></ol></li></ol>

    </div>
</div>
            </div>
        
    </div>
</div>


                

            </div>
            
            

        </div>

        <div class="main-content-footer">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info">
            &copy;
            
              <span>2022</span>
              -
            
            2023&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">kita17</a>
        </div>
        
            <script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv" class="busuanzi_container_site_uv">
                        VISITOR COUNT&nbsp;<span id="busuanzi_value_site_uv" class="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="busuanzi_container_site_pv">
                        TOTAL PAGE VIEWS&nbsp;<span id="busuanzi_value_site_pv" class="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            <span class="powered-by-container">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" href="https://hexo.io">Hexo</a></span>
                <br>
            <span class="theme-version-container">THEME&nbsp;<a class="theme-version" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.1.5</a>
        </div>
        
        
        
        
        
        
        
    </div>  
</footer>
        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="article-tools-list">
        <!-- TOC aside toggle -->
        
            <li class="right-bottom-tools page-aside-toggle">
                <i class="fa-regular fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-side-tools-container">
        <div class="side-tools-container">
    <ul class="hidden-tools-list">
        <li class="right-bottom-tools tool-font-adjust-plus flex-center">
            <i class="fa-regular fa-magnifying-glass-plus"></i>
        </li>

        <li class="right-bottom-tools tool-font-adjust-minus flex-center">
            <i class="fa-regular fa-magnifying-glass-minus"></i>
        </li>

        <li class="right-bottom-tools tool-expand-width flex-center">
            <i class="fa-regular fa-expand"></i>
        </li>

        <li class="right-bottom-tools tool-dark-light-toggle flex-center">
            <i class="fa-regular fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="right-bottom-tools tool-scroll-to-bottom flex-center">
            <i class="fa-regular fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="visible-tools-list">
        <li class="right-bottom-tools toggle-tools-list flex-center">
            <i class="fa-regular fa-cog fa-spin"></i>
        </li>
        
            <li class="right-bottom-tools tool-scroll-to-top flex-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
        
    </ul>
</div>

    </div>

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fa-solid fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fa-solid fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    


</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/layouts/navbarShrink.js"></script>

<script src="/js/tools/scrollTopBottom.js"></script>

<script src="/js/tools/lightDarkSwitch.js"></script>



    
<script src="/js/tools/localSearch.js"></script>




    
<script src="/js/tools/codeBlock.js"></script>




    
<script src="/js/layouts/lazyload.js"></script>






  
<script src="/js/libs/Typed.min.js"></script>

  
<script src="/js/plugins/typed.js"></script>







<div class="post-scripts pjax">
    
        
<script src="/js/tools/tocToggle.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/layouts/toc.js"></script>

<script src="/js/plugins/tabs.js"></script>

    
</div>


    
<script src="/js/libs/pjax.min.js"></script>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax',
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            Global.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            Global.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            Global.refresh();
        });
    });
</script>




</body>
</html>
